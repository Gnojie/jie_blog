## æ’ä»¶åŒ–æ¦‚å¿µ

ğŸ¤” æ’ä»¶åŒ–/ç»„ä»¶åŒ–(æ¥¼å±‚å¼‚æ­¥ç»„ä»¶)/å‡½æ•°å¼ç¼–ç¨‹(ç»„åˆ)ï¼Ÿ

- å‰ç«¯æ‰“åŒ…å·¥å…·çš„æ’ä»¶åŒ– ğŸ”Œ
  - webpackçš„å„ç§cssã€vueçš„ plugin
  - babelçš„å„ç§éœ€å°é²œç‰ˆæ–°ESè¯­æ³•ç¼–è¯‘æ’ä»¶
  - rollup
  - vite
- å‰ç«¯æ¡†æ¶çš„æ’ä»¶åŒ–
  - Vuejsæ¸è¿›å¼çš„routerã€vuexç­‰
  - React
  - UmiJSã€Eggjsã€DvaJSç­‰
- ä»£ç ç¼–è¾‘å™¨
  - VSCodeçš„å„ç§æ’ä»¶: prettierã€ä¸»é¢˜çš®è‚¤ç­‰
- æµè§ˆå™¨
  - è°·æ­Œæµè§ˆå™¨çš„æ’ä»¶å¸‚åœº
  - urlè·å–åˆ°çš„ç½‘é¡µå¯ä»¥è§†ä¸ºæ’ä»¶ï¼Œæµè§ˆå™¨çª—å£åˆ™æ˜¯ä¸»ä½“ç¨‹åº

ä¼˜ç‚¹ï¼š
- å‡å°‘ä¸»ä½“çš„å¤æ‚åº¦ï¼Œç²¾ç®€æ ¸å¿ƒ
  - webpack ã€babel å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯æ’ä»¶ï¼Œä¸»ä½“ä¸»è¦æ˜¯è½¯ä»¶ç”Ÿå‘½å‘¨æœŸè°ƒé…ï¼ŒçŠ¶æ€æµè½¬ç­‰ï¼Œä»¥åŠå°‘é‡æ ¸å¿ƒèƒ½åŠ›çš„å®ç°
- æ¸è¿›å¼ï¼ŒæŒ‰éœ€ä½¿ç”¨
  - Vuejsï¼Œæ’ä»¶æ›´å¤šæ˜¯å¯¹å…¶èƒ½åŠ›ä¸Šçš„ä¸€ä¸ªè¡¥å……
- ç‹¬ç«‹äºä¸»ä½“ï¼Œæ–°å¢åŠŸèƒ½ä¸éœ€è¦å‘å¸ƒå‡çº§
- å¯æ‰©å±•æ€§ï¼Œå€ŸåŠ©ç¤¾åŒºæå‡ç”Ÿå‘½åŠ›


è®¾è®¡æ€è·¯ï¼š
- å“ªäº›æ˜¯æ˜“å˜çš„ï¼Œå“ªäº›æ˜¯ç›¸å¯¹ç¨³å®šçš„
  - æ˜“å˜çš„éƒ¨åˆ†åº”æš´éœ²å‡ºç›¸åº”çš„èƒ½åŠ›ç”±æ’ä»¶æ¥å®Œæˆ
- æ’ä»¶å¦‚ä½•å½±å“ä¸»ä½“ç¨‹åº
  - é€šå¸¸ä¼šä»¥æ‰©å±•è¡Œä¸ºï¼Œä¿®æ”¹çŠ¶æ€ï¼Œå˜æ›´å±•ç¤ºçš„æ–¹å¼ä½“ç°

## è®¾è®¡ä¸€ä¸ª ğŸ”Œæ’ä»¶åŒ–è®¡ç®—å™¨

### æ™®é€šè®¡ç®—å™¨

```js
// è®¡ç®—å™¨
class Calculator {
  construct(initVal) {
    this.num = initVal;
  }
  // åŠ æ³•
  add(num) {
    this.num = this.num + num;
    return this;
  }
  // å‡æ³•
  subtract(num) {
    this.num = this.num - num;
    return this;
  }
  // ç»“æœ
  result() {
    return this.num;
  }
}

const myCalculator = new Calculator(5);
myCalculator.add(5).subtract(2).result(); // 8
```
ğŸ‘† åªæœ‰åŠ å‡æ³•

### æ’ä»¶è®¡ç®—å™¨-æ’ä»¶å®šä¹‰

æŒ‰ç…§è®¾è®¡æ€è·¯ï¼š
- ä¸»ä½“æ˜¯è¿ç®—ï¼šå½“å‰å€¼å’Œä¸€ä¸ªæ–°å€¼çš„è¿ç®—è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†æ˜¯ç¨³å®šçš„
- æ”¯æŒçš„è¿ç®—é€»è¾‘(åŠ /å‡æ³•ğŸ”§å·¥å…·å‡½æ•°)æ˜¯å¯æ‰©å±•çš„ï¼Œé€‚åˆåšæˆæ’ä»¶

ğŸ‘‡ è¿ç®—æ’ä»¶æä¾›è®¡ç®—é€»è¾‘ä½œä¸ºå›è°ƒå‡½æ•°
```ts
// æ’ä»¶ç±»å‹å£°æ˜
interface Plugin {
  name: string;
  calculate(num: number) => this;
}

// åŠ æ³•æ’ä»¶
class AddPlugin implements Plugin {
  name: 'add',
  calculate(num) {
    this.num = this.num + num;
    return this;
  }
}

// å‡æ³•æ’ä»¶
class SubtractPlugin implements Plugin {
  name: 'subtract',
  calculate(num) {
    this.num = this.num - num;
    return this;
  }
}
```
ğŸ‘† name ç”¨äºè°ƒç”¨æ–¹æŒ‡å®šä½¿ç”¨å“ªä¸ªæ’ä»¶è®¡ç®—é€»è¾‘ï¼Œä¸»ä½“ç¨‹åºè°ƒç”¨ç›¸åº”æ’ä»¶æä¾›çš„å›è°ƒ

### æ’ä»¶è®¡ç®—å™¨-ä¸»ä½“ç¨‹åº

- ä¸»ä½“ç¨‹åºè°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°å­˜å‚¨ç»“æœï¼Œç”¨äºä¸‹ä¸€æ¬¡è®¡ç®—

```js
// ç¨‹åºä¸»ä½“ï¼Œå®šä¹‰ç¨‹åºæ ¸å¿ƒé€»è¾‘æ˜¯å¢åŠ è®¡ç®—å™¨è¿ç®—èƒ½åŠ›
class Calculator {
  plugins = [];
  construct(initVal) {
    this.num = initVal;
  }

  // å®‰è£…æ’ä»¶
  use(plugin) {
    this.plugins.push(plugin);
    this[plugin.name] = plugin.calculate.bind(this);
  }

  // ç»“æœ
  result() {
    return this.num;
  }

  // è¾“å‡ºæ’ä»¶ä¿¡æ¯ï¼Œæ ¹æ®æ’ä»¶ä¿¡æ¯äº†è§£æ”¯æŒä»€ä¹ˆè¿ç®—
  help() {
    return `support ${this.plugins.map(plugin => plugin.name).join(',')}`;
  }
}
```

### æ’ä»¶è®¡ç®—å™¨-ä½¿ç”¨

```js
// åˆå§‹åŒ–è®¡ç®—å™¨
const myCalculator = new Calculator(5);
// å®‰è£…æ’ä»¶
myCalculator.use(new AddPlugin());
myCalculator.use(new SubtractPlugin());
 
myCalculator.add(5).subtract(2).result(); // 8
```

## æ’ä»¶åŒ–ç³»ç»Ÿç»„æˆ

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221214111326.png)

- Program: ä¸»ä½“ç¨‹åºï¼Œæœ‰ç€ä¸€å®šé¡ºåºçš„ç”Ÿå‘½å‘¨æœŸ Hooksï¼Œå¯ä»¥åœ¨ä¸åŒæ—¶æœŸè°ƒç”¨æ’ä»¶
- Plugin Loader: æ’ä»¶ç®¡ç†é€»è¾‘ï¼Œå¯¹åº”ğŸ‘†æ’ä»¶åŒ–è®¡ç®—å™¨çš„ useï¼Œæœ€åŸºç¡€çš„æ˜¯å®‰è£…ã€è°ƒç”¨é€»è¾‘ï¼Œå¯ä»¥æœ‰å¤æ‚çš„ç®¡ç†é€»è¾‘ï¼Œå¦‚å¸è½½æ’ä»¶ç­‰
- Plugins: æ’ä»¶åˆ—è¡¨
- Plugin Impl: æ’ä»¶å®ç°(Plugin Implementation)ï¼Œå°±æ˜¯æ’ä»¶å†…å®¹
- Plugin Interface: æ’ä»¶æ¥å£å£°æ˜ï¼Œå¯¹åº”ğŸ‘†æ’ä»¶åŒ–è®¡ç®—å™¨çš„ç±»å‹å£°æ˜ï¼Œç”¨äºç»™å¼€å‘è€…äº†è§£ä¸€ä¸ªæ’ä»¶çš„åŸºæœ¬å±æ€§
  - ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸»ä½“ç¨‹åºï¼Œæ³¨å…¥ç»™æ’ä»¶çš„æ•°æ®çŠ¶æ€ï¼Œæˆ–ç‰¹æ®Šå›è°ƒ

## webpack

webpack æ ¸å¿ƒæ¨¡å—(ä¸»ä½“ç¨‹åº)ä¸ºcompiler å’Œ compilationï¼Œä»–ä»¬éƒ½æœ‰å„è‡ªçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆHookï¼‰

webpack æ ¸å¿ƒ(ä¸»ä½“ç¨‹åº)å®šä¹‰ç”Ÿå‘½å‘¨æœŸï¼ˆæˆ–è€…å«äº‹ä»¶æµï¼‰
æ’ä»¶ç®¡ç†é€»è¾‘(Plugin Loader)ï¼Œå°±æ˜¯åœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨æ’ä»¶åœ¨å¯¹åº”ç”Ÿå‘½å‘¨æœŸæ³¨å†Œçš„æ–¹æ³•

ğŸ‘† ç›¸å¯¹äºæ’ä»¶åŒ–è®¡ç®—å™¨ï¼Œä¸€ä¸ªæ’ä»¶é™¤äº†å®šä¸€ä¸ªæ’ä»¶åã€å›è°ƒå‡½æ•°å¤–
è¿˜éœ€è¦æŠŠå›è°ƒå‡½æ•°æŒ‡å®šä¸ºä¸ç—›çš„webpack Hooksè°ƒç”¨

å› ä¸ºè¿™æ ·ä¸»ä½“ç¨‹åºä¸­å°±æ¶‰åŠç”Ÿå‘½å‘¨æœŸä¸­æ’å…¥é€»è¾‘
é‚£ä¹ˆè¿™æ®µé€»è¾‘æ˜¯
- åŒæ­¥æ‰§è¡Œ/å¼‚æ­¥æ‰§è¡Œ
- å¹¶è¡Œæ‰§è¡Œ/ä¸²è¡Œæ‰§è¡Œ
- æ‰§è¡Œç»“æœéœ€ä¸éœ€è¦å½±å“ä¹‹åçš„ç”Ÿå‘½å‘¨æœŸ

å› æ­¤ä¸»ä½“ç¨‹åºä¸ºäº†é€‚åº”æ’ä»¶ï¼Œéœ€è¦æœ‰å®Œå–„çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¤„ç†æœºåˆ¶
`webpack` å°è£…äº†ä¸€ä¸ª `Hook` çš„æ ¸å¿ƒåº“ `Tapable` ï¼Œ `compiler` å’Œ `compilation` éƒ½æ˜¯åŸºäº `Tapable` çš„å®ç°

ğŸ‘‡ ä¹Ÿå°±æ˜¯webpackçš„ç”Ÿå‘½å‘¨æœŸHooksæœ‰ä¸€å®šçš„å¤æ‚é€»è¾‘åœ¨
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221214112944.png)

TODO: å…³äº `Tapable` æˆ‘ä»¬åœ¨ [é‡å­¦webpack](../webpack/é‡å­¦webpack-04plugin.md) é‡Œè¯¦ç»†è®²è§£

è¿™é‡Œæœ‰ä¸€ä¸ªæ¨¡ç³Šçš„æ¦‚å¿µå³å¯ï¼šwebpack çš„Hooksäº‹ä»¶å¤„ç†æœºåˆ¶å°±æ˜¯ä¸€ä¸ª EventEmitter(å‘å¸ƒè®¢é˜…æ¨¡å¼ç­‰) 

## TODO: rollup

rollupæ€ä¹ˆå¤„ç†æ’ä»¶ [PluginDriver](https://github.com/rollup/rollup/blob/master/src/utils/PluginDriver.ts)


## jQuery

```js
(function ($) {
  $.fn.myPlugin = function () { ... }
})(jQuery)
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221214123631.png)

ğŸ‘‡ ç¤ºä¾‹

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221214123927.png)

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221214123939.png)

- pluginCoreï¼šä¸»ä½“ç¨‹åºé€šè¿‡åŸå‹é“¾æ¥æŒ‚è½½ä¸åŒçš„æ’ä»¶
  - æ‰‹åŠ¨è·å¾—jQueryå®ä¾‹(ä¸»ä½“å¯¹è±¡)åè°ƒç”¨æ’ä»¶ï¼Œè€Œä¸æ˜¯ä¸»ä½“ç¨‹åºæœ‰ç”Ÿå‘½å‘¨æœŸHookè‡ªåŠ¨è°ƒç”¨æ’ä»¶
  - ğŸ˜– æ›´åƒæ˜¯æ–°å¢äº†ğŸ”§å·¥å…·æ–¹æ³•ï¼Œè€Œæ”¾ç½®çš„åœ°æ–¹ä¸æ˜¯å…¨å±€å˜é‡ï¼Œä¹Ÿä¸æƒ³è‡ªå·±å¼•å…¥ï¼Œäºæ˜¯æ”¾åˆ°è¿™ä¸ªä¸»ä½“ä¸Š
- pluginï¼šæ— é™åˆ¶ï¼Œå¯ä»¥æ˜¯JavaScriptçš„ç±»å‹ï¼Œä¸€èˆ¬æ˜¯å®ç°å…·ä½“åŠŸèƒ½çš„æ¨¡å—ï¼Œæ¯”å¦‚ï¼Œæ—¥æœŸé€‰æ‹©å™¨ç­‰ã€‚

### babel

ğŸ‘‡ babelæ’ä»¶ç»“æ„
```js
function () {
  return {
    name: 'æ’ä»¶å',
    visitor: {
      enter(nodePath) {},
      exit(nodePath) {},
      [NodeType](nodePath) {},
      // NodeTypeæŒ‡çš„æ˜¯babelè½¬è¯‘ASTå¾—åˆ°çš„èŠ‚ç‚¹ç±»å‹ï¼Œåˆ©ç”¨è¿™ä¸ªèŠ‚ç‚¹ç±»å‹ä½œä¸ºå›è°ƒå‡½æ•°çš„key
    }
  }
}
```
å¯ä»¥çœ‹å‡ºå’Œ ğŸ‘†æ’ä»¶åŒ–è®¡ç®—å™¨éå¸¸åƒï¼Œåªæ˜¯å›è°ƒå‡½æ•°æ”¹ä¸ºäº†ä¸€ä¸ªå¯¹è±¡å­˜å‚¨é™åˆ¶å˜é‡åçš„å‡½æ•°å±æ€§

ğŸ‘‡ ç®­å¤´å‡½æ•°è½¬è¯‘æ’ä»¶ [babel-plugin-transform-arrow-functions](https://github.com/babel/babel/blob/main/packages/babel-plugin-transform-arrow-functions/src/index.ts)

```ts
import { declare } from "@babel/helper-plugin-utils";

export interface Options {
  spec?: boolean;
}

export default declare((api, options: Options) => {
  api.assertVersion(7);

  const noNewArrows = api.assumption("noNewArrows") ?? !options.spec;

  return {
    name: "transform-arrow-functions",

    visitor: {
      ArrowFunctionExpression(path) {
        // In some conversion cases, it may have already been converted to a function while this callback
        // was queued up.
        if (!path.isArrowFunctionExpression()) return;

        path.arrowFunctionToExpression({
          // While other utils may be fine inserting other arrows to make more transforms possible,
          // the arrow transform itself absolutely cannot insert new arrow functions.
          allowInsertArrow: false,
          noNewArrows,

          // TODO(Babel 8): This is only needed for backward compat with @babel/traverse <7.13.0
          specCompliant: !noNewArrows,
        });
      },
    },
  };
});
```

- ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œè¯¥æ’ä»¶ï¼Œè·å–åˆ°åŒ…å«visitorå¯¹è±¡ï¼›
- ç¬¬äºŒæ­¥ï¼Œ`AST` éå†èŠ‚ç‚¹ï¼Œæ£€æµ‹nodePathçš„type === 'ArrowFunctionExpression'ï¼Œå¯»æ‰¾åˆ°vistorå¯¹è±¡çš„ä¸­keyä¸º ArrowFunctionExpressionçš„å‡½æ•°ï¼›
- ç¬¬ä¸‰æ­¥ï¼Œå°†nodePathä¼ å…¥è¯¥å‡½æ•°è¿›è¡Œè°ƒç”¨ï¼ˆASTåœ¨è¿™æ­¥è¢«ä¿®æ”¹ï¼‰ï¼›

---

ğŸ¤”æ€è€ƒ: babelä¸»ä½“ç¨‹åºï¼Œæ€ä¹ˆç®¡ç†å¤šä¸ªæ’ä»¶å¯¹åŒä¸€ä¸ªASTèŠ‚ç‚¹ç±»å‹åšè½¬è¯‘å›è°ƒï¼Ÿ

åˆå¹¶æ‰€æœ‰ä½¿ç”¨åˆ°çš„babelæ’ä»¶çš„å±æ€§ï¼š
- é€šè¿‡è§£æbabelçš„é…ç½®æ–‡ä»¶ï¼ˆæˆ–è€…å‘½ä»¤è¡Œ--pluginså‚æ•°ï¼‰ï¼Œè·å–Babelé…ç½®çš„æ‰€æœ‰æ’ä»¶çš„æè¿°ï¼›
- å°†æ’ä»¶çš„requireè¿›å†…å­˜ï¼Œè·å¾—æ’ä»¶å‡½æ•°ï¼Œå¹¶æ‰§è¡Œæ’ä»¶å‡½æ•°ï¼Œè·å–åˆ°å¤šä¸ªåŒ…å«vistorå­—æ®µå¯¹è±¡ï¼›ï¼ˆè¯¦ç»†é€»è¾‘ï¼š[@babel/core/src/config/full.js](https://github.com/babel/babel/blob/fa975bf7cd2b9054faaff107a79e41dcaad305b1/packages/babel-core/src/config/full.js)ï¼‰
- å°†å¤šä¸ªåŒ…å«vistorå­—æ®µå¯¹è±¡æ•´åˆæˆä¸€ä¸ªå¤§çš„visitoræºç å±•ç¤ºï¼ˆè¯¦ç»†é€»è¾‘ï¼š[@babel/core/src/transformation/index.js](https://github.com/babel/babel/blob/fa975bf7cd2b9054faaff107a79e41dcaad305b1/packages/babel-core/src/transformation/index.js#L107)ï¼‰ï¼š
- ASTéå†æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ ¹æ® NodeTypeï¼Œæ¥è·å– visitor[NodeType]ï¼Œå¹¶ä¾æ¬¡æ‰§è¡Œ

```js
// @babel/traverse
const visitor = traverse.visitors.merge(
  visitors,
  passes,
  file.opts.wrapPluginVisitorMethod
)
```
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221214131255.png)

ğŸ‘† èŠ‚ç‚¹ç±»å‹å¯¹åº”çš„è½¬è¯‘æ’ä»¶é€»è¾‘å˜æˆäº† Array<function(nodePath)>

---

## vue-cli

> å†…éƒ¨æºç æ˜¯æ’ä»¶åŒ–çš„



## Reactæ’ä»¶åŒ–ç»„ä»¶åº“-DevExtreme Reactive

ç›®å‰åŒ…å«äº† Grid / Chart / Scheduler ä¸‰ä¸ªå¤æ‚ç»„ä»¶ï¼Œè¿™ä¸‰ä¸ªç»„ä»¶éƒ½æ˜¯åŸºäºä¸€ä¸ªæ’ä»¶åŒ–æ¡†æ¶è¿›è¡Œå¼€å‘çš„ã€‚

```jsx
import { PluginHost, Plugin, Template, Getter, Action } from '@devexpress/dx-react-core';

export default function PluginRoot(props) {
 const { chidren } = props;
 return <PluginHost>{children}</PluginHost>;
}

export function FeatureA() {
 return (
   <Plugin name="A">
     <Template name="...">...</Template>
     <Getter name="..." />
     <Action name="..." />
   </Plugin>
 );
}
export function FeatureB() {
 return (
   <Plugin name="B">
     <Template>...</Template>
     <Getter name="..." />
     <Action name="..." />
   </Plugin>
 );
}
```

ğŸ‘† ç±»ä¼¼Vuejsæ’æ§½ï¼Œ `pluginæ ‡ç­¾` å†…çš„ `nameæ ‡ç­¾` ä¼šæ’å…¥åˆ°ä¸»ä½“ç¨‹åºçš„ `pluginhostæ ‡ç­¾` å†…çš„ `name` çš„ä½ç½®
```jsx
// App.jsx
import PluginRoot, { FeatrueA, FeatureB, ... FeatureN } from './MyComponnent;'

const App = () => (
 <PluginRoot>
   <FeatureA />
   <FeatureB />
   ...
   <FeatrueN />
 </PluginRoot>
);

ReactDOM.render(<App />, rootNode);
```

## å‚è€ƒèµ„æ–™

- [å‰ç«¯é¢†åŸŸçš„æ’ä»¶å¼è®¾è®¡](https://mp.weixin.qq.com/s/_Qy8wScgq86vLBwNU-tTfw)

UmiJSï¼Ÿ

- [TODO:å¼‚æ­¥ç»„ä»¶è®¾è®¡](./å¼‚æ­¥ç»„ä»¶è®¾è®¡.md)