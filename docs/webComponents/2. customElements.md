## Custom Elements
> è‡ªå®šä¹‰å…ƒç´ 
> åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒè‡ªå®šä¹‰å…ƒç´ 
> `if( 'customElements' in window )`

[customElements](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/customElements) æ˜¯ä¸€ä¸ªæµè§ˆå™¨windowä¸‹çš„å…¨å±€å˜é‡å·¥å…·

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20220515112510.png)

ç¬¬äºŒä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ªclassç±»ï¼Œè¿™ä¸ªclassç±»è¦ç»§æ‰¿å…ƒç´ æ„é€ å™¨ `class extends HTMLElement { }`

### ç»§æ‰¿å…¶ä»–web Components
å‡å¦‚æˆ‘ä»¬è¦äºŒæ¬¡å°è£…åˆ«äººçš„ `Web Components`ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è‡ªå®šä¹‰å…ƒç´ ååï¼Œç»§æ‰¿åŸ `Web Components`

ç”¨ [customElements.get( )](https://developer.mozilla.org/zh-CN/docs/Web/API/CustomElementRegistry/get) è·å–å·²ç»å®šä¹‰çš„åŸ `Web Components`

å¦‚ğŸ‘‡
```js
customElements.define('my-p', class extends customElements.get('origin-ui-p') {
  constructor() {
    super()
    // æ­¤æ—¶å†™å…¥çš„thisæ“ä½œå°†æ˜¯åŸºäºåŸç»„ä»¶åšçš„é¢å¤–æ“ä½œ
    this.onclick = () => alert('åŸºäºåŸç»„ä»¶çš„é¢å¤–ç‚¹å‡»äº‹ä»¶')
  }
})
```


### ä¸ºä»€ä¹ˆå¼ºåˆ¶è¦æ±‚å‘½åå¸¦-
æµè§ˆå™¨è§£æhtmlï¼Œä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œæˆ‘ä»¬å¸¸å¸¸è¦æ±‚åœ¨domå…ƒç´ å‰å…ˆå¼•å…¥cssèµ„æºï¼Œåœ¨domå…ƒç´ åå¼•å…¥jsèµ„æºï¼Œæ˜¯ä¸ºäº†è®©é¡µé¢åœ¨æ— è§†jså…ˆæ¸²æŸ“å‡ºå†…å®¹

> é‚£ä¹ˆå½“å‡ºç°äº†jså®šä¹‰çš„è‡ªå®šä¹‰å…ƒç´ æ ‡ç­¾æ—¶ï¼Œjsè¿˜èƒ½å†™åœ¨domå…ƒç´ åé¢å—ï¼Ÿ
> æ˜¯å¯ä»¥çš„

htmlé‡åˆ°å¸¦ `-` çš„æ ‡ç­¾ï¼Œå¹¶ä¸”ä¸æ˜¯åŸç”Ÿæ ‡ç­¾å°†ä¼šè·³è¿‡æ¸²æŸ“å¹¶è®¤ä¸ºæ˜¯æœªå®šä¹‰çš„æ ‡ç­¾ï¼Œè€Œä¸æ˜¯æŠ¥é”™
è€Œä¸å¸¦ `-` çš„æ ‡ç­¾å°†ä¸€å¾‹è®¤ä¸ºæ˜¯åŸç”Ÿæ ‡ç­¾ï¼Œå¦‚æœæ˜¯ä¸è®¤è¯†çš„æ ‡ç­¾å°†ä¼šæŠ¥é”™


### ä¼ªç±»é€‰æ‹©å™¨ é€‰ä¸­æœªå®šä¹‰çš„è‡ªå®šä¹‰æ ‡ç­¾
> ä¸Šé¢è¯´åˆ°æµè§ˆå™¨ä¼šè·³è¿‡æ¸²æŸ“æœªå®šä¹‰çš„æ ‡ç­¾
> è¿™é‡Œæœ‰ä¸ªä¼ªç±»é€‰æ‹©å™¨å¯ä»¥é€‰ä¸­å·²å®šä¹‰çš„å…ƒç´ æ ‡ç­¾
> `:defined { }` ï¼Œè¿›è¡Œæ ·å¼ç¼–å†™

é‚£ä¹ˆå‡å¦‚æˆ‘ä»¬è¦é€‰ä¸­æœªå®šä¹‰çš„å…ƒç´ æ ‡ç­¾(è‡ªå®šä¹‰å…ƒç´ )
`:not(:defined) {}`

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»™è¿™ä¸ª `Web Components` åšä¸€ä¸ªåŠ è½½æ•ˆæœ

```html
<html>
  <head>
    <meta charset="utf-8">
    <title>demo</title>
    <style>
      body { display: grid; place-items: center; }
      :not(:defined) {
        width: 120px;
        height: 20px;
        background: gray linear-gradient(60deg, transparent, transparent 20%, white 40%, transparent 60%) 0/300%;
        border-radius: 4px;
        animation: loading 2s infinite;
      }
      @keyframes loading {
        to { background-position: 300% 0 }
      }
    </style>    
  </head> 
  <body>
    <my-p></my-p>
    <script>
      setTimeout(()=>{
        customElements.define('my-p', class extends HTMLElement {
          constructor() {
            super()
            this.innerHTML = '<p>Web Components</p>'
          }
        })
      },3000)
    </script>
  </body>
</html>
```
æ•ˆæœå¦‚ğŸ‘‡
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/webcomponents.gif)

## customElements.whenDefined
> ğŸ‘† å·²ç»ç”¨åˆ°äº† `customElements`ä¸Šçš„`defind`æ–¹æ³•åˆ›å»ºå®šä¹‰è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå®ƒè¿˜æœ‰å…¶ä»–çš„å‡ ä¸ªæ–¹æ³•å¯ä»¥ä½¿ç”¨
> å› ä¸ºä¸ç®—å¸¸ç”¨ï¼Œæš‚æ—¶å…ˆä¸ä»”ç»†ç ”ç©¶ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿä¸ç®—è¯¦ç»†ï¼Œå…ˆæœ‰ä¸ªå°è±¡

[customElements.whenDefined( )](https://developer.mozilla.org/zh-CN/docs/Web/API/CustomElementRegistry/whenDefined)

## è‡ªå®šä¹‰æ ‡ç­¾ç”Ÿå‘½å‘¨æœŸ

```js
customElements.define('my-p', class extends HTMLElement {
  // ç›¸å½“äºvue3çš„setup
  constructor() {
    super()
    this.innerHTML = '<p>Web Components</p>'
  }
  // ç›¸å½“äºvueçš„mounted
  connectedCallback(){
    console.log('connectedCallback')
  }
  // ç›¸å½“äºvue3çš„unmounted
  disconnectedCallback(){
    console.log('disconnectedCallback')
  }
  adoptedCallback(){
    console.log('adoptedCallback')
  }
})
```

### connectedCallback
> å½“ WebComponents ç¬¬ä¸€æ¬¡è¢«æŒ‚åœ¨åˆ° dom ä¸Šæ˜¯è§¦å‘çš„é’©å­ï¼Œå¹¶ä¸”åªä¼šè§¦å‘ä¸€æ¬¡ã€‚ç±»ä¼¼ Vue ä¸­çš„ mounted React ä¸­çš„ useEffect(() => {}, [])ï¼ŒcomponentDidMountã€‚

### disconnectedCallback
> å½“è‡ªå®šä¹‰å…ƒç´ ä¸æ–‡æ¡£ DOM æ–­å¼€è¿æ¥æ—¶è¢«è°ƒç”¨ã€‚

### adoptedCallback
> adopted: æ”¶å…»ã€é‡‡ç”¨
> å½“è‡ªå®šä¹‰å…ƒç´ è¢«ç§»åŠ¨åˆ°æ–°æ–‡æ¡£æ—¶è¢«è°ƒç”¨

å¦‚åœ¨ domæ“ä½œè¿è¡Œæˆ‘ä»¬ç§»åŠ¨iframeçš„å…ƒç´ åˆ°ä¸»æ–‡æ¡£document
[Document.adoptNode( ) -MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/adoptNode)
æ•ˆæœç±»ä¼¼å‰ªåˆ‡
æ­¤æ—¶å‰ªåˆ‡çš„domå…ƒç´ æ˜¯è‡ªå®šä¹‰å…ƒç´ æ ‡ç­¾çš„è¯ï¼Œå°†ä¼šè§¦å‘è‡ªå®šä¹‰æ ‡ç­¾çš„`adoptedCallback`ç”Ÿå‘½å‘¨æœŸ

## attributeChangedCallback
> attributeChangedCallback ä¹Ÿæ˜¯è‡ªå®šä¹‰è‡ªå®šä¹‰å±æ€§çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯æˆ‘ä»¬å•ç‹¬æ¥çœ‹
> å­—é¢æ„æ€ï¼Œå±æ€§å˜åŒ–æ—¶è§¦å‘
> ç±»ä¼¼vueçš„watch
> æ³¨æ„å®ƒä¸æ˜¯å…ƒç´ çš„prop
> æ³¨æ„å®ƒçš„è§¦å‘æ—¶æœºæ¯”`connectedCallback`æŒ‚è½½è¦æ—©,å¯ä»¥ç”¨`oldVal`æœ‰æ²¡æœ‰å€¼åˆ¤æ–­æ˜¯å¦æœªæŒ‚è½½

æœ¬ç”Ÿå‘½å‘¨æœŸèµ·ä½œç”¨çš„å‰ææ˜¯å…ˆå®šä¹‰éœ€è¦ç›‘å¬çš„å±æ€§å`static get observedAttributes()`ï¼Œå› ä¸ºæ ‡ç­¾ä¸Šçš„é¢„ç½®å±æ€§æ˜¯éå¸¸å¤šçš„
è¿™æ ·çš„å†™æ³•å°±ä¼šéå¸¸åƒvueçš„watchç”Ÿæ•ˆéœ€è¦å…ˆåœ¨dataå£°æ˜

ğŸ‘‡ å®ç° `input` å±æ€§çš„ `placeholder`
```html
<html>
<head>
  <title>demo</title>
</head>
<body>
  <my-input placeholder="è¯·è¾“å…¥"></my-input>
  <script>
    customElements.define('my-input', class extends HTMLElement {
      // ç±»ä¼¼vueçš„watchç›‘å¬å‰éœ€è¦åœ¨dataä¸­å£°æ˜
      static get observedAttributes() { return ['placeholder'] }
      // è¿™ä¸ªsetæ˜¯ä¸ºäº†å®ç°ç›´æ¥æ“ä½œdom.placeholder = xx ä¹Ÿç”Ÿæ•ˆ
      // ä¸åŠ è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™jsåªèƒ½é€šè¿‡dom.setAttribute()å®ç°ä¿®æ”¹
      set placeholder(val) {
        this.querySelector('input').setAttribute('placeholder',val)
      }

      constructor() {
        super()
        this.innerHTML = '<input>'
      }
      // æŸ¥çœ‹attributeChangedCallback å’Œ connectedCallback é¡ºåº
      connectedCallback() {
        console.log('connectedCallback')
      }
      // å¯ä»¥ç”¨ oldVal æœ‰æ²¡æœ‰å€¼åˆ¤æ–­æ˜¯å¦æœªæŒ‚è½½
      attributeChangedCallback(key, oldVal, newVal) {
        console.log('è§¦å‘attributeChangedCallback', key, oldVal, newVal)
        if(key === 'placeholder') {
          this.querySelector('input').setAttribute('placeholder',newVal)
        }
      }
    })
  </script>
</body>
</html>
```

## ç»§æ‰¿å…¶ä»–åŸç”Ÿå…ƒç´ dom
ğŸ‘† çš„placeholderç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨é€‰ä¸­å†…éƒ¨çš„çœŸå® input æ ‡ç­¾æ¥è®¾ç½®placeholder
æˆ‘ä»¬ç°åœ¨å¸Œæœ›æˆ‘ä»¬çš„è‡ªå®šä¹‰æ ‡ç­¾å°±æ˜¯inputæ ‡ç­¾ï¼Œå®ƒè‡ªå¸¦ç€placeholderåŠŸèƒ½

```html
<html>
<head>
  <title>demo</title>
</head>
<body>
  <input is="my-input" placeholder="è¯·è¾“å…¥"></input>
  <script>
    customElements.define('my-input', class extends HTMLInputElement {
      constructor() {
        super()
        this.disabled = true
      }
    }, { extends: 'input' })
  </script>
</body>
</html>
```
ğŸ‘†çš„è‡ªå®šä¹‰æ ‡ç­¾å®šä¹‰çš„æ—¶å€™ï¼Œä¸å†ç»§æ‰¿`HTMLElement` è€Œæ˜¯ `HTMLInputElement`
å…¶ä»–å…·ä½“çš„æ ‡ç­¾éƒ½æ˜¯ç±»ä¼¼çš„åšæ³•ï¼Œä»–ä»¬çš„æœ¬è´¨éƒ½æ˜¯ç»§æ‰¿è‡ª `HTMLElement`

å¹¶ä¸”éœ€è¦å†™ä¸Šç¬¬3ä¸ªå‚æ•°ï¼Œ `{ extends: 'input' }`

æ³¨æ„è¿™ç§å†™æ³•ï¼Œ`safari` ä¸æ”¯æŒ
[Safariä¸æ”¯æŒbuild-inè‡ªå®šä¹‰å…ƒç´ çš„å…¼å®¹å¤„ç†](https://www.zhangxinxu.com/wordpress/2021/04/safari-buildin-custom-element-polyfill/)
å¼•å…¥ `polyfill` çš„ `custom-elements-builtin` jsåº“æ¥å…¼å®¹safariï¼Œä½†æ˜¯è¿˜æœ‰äº›ç»†å¾®æ“ä½œï¼Œè¯¦è§ğŸ‘†çš„æ–‡ç« 


## å‚è€ƒææ–™

- [customElements - MDN](https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_custom_elements)
- [å¦‚ä½•åŸºäº WebComponents å°è£… UI ç»„ä»¶åº“ - æ”¿é‡‡äº‘](https://www.zoo.team/article/web-components)
- [Safariä¸æ”¯æŒbuild-inè‡ªå®šä¹‰å…ƒç´ çš„å…¼å®¹å¤„ç†](https://www.zhangxinxu.com/wordpress/2021/04/safari-buildin-custom-element-polyfill/)