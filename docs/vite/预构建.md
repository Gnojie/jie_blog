

é¢„æ„å»ºè¿™ä¸ªåè¯å®¹æ˜“è®©äººä¸æ¸…æ¥šåˆ°åº•å‘ç”Ÿåœ¨ä»€ä¹ˆé˜¶æ®µï¼Œæˆ‘ä»¬å…ˆæŠ›ä¸‹è¿™ä¸ªè¯çš„å­—é¢æ„æ€

## é¢„æ„å»º do what

- ä»…å‘ç”Ÿåœ¨ dev é˜¶æ®µï¼ŒViteDevServer æä¾›çš„åŠŸèƒ½
- åˆ©ç”¨ esbuild è½¬åŒ– CommonJS/UMD --> ESM
  - éš¾ç‚¹åœ¨äºè½¬åŒ–åçš„ä»£ç è¦æ”¯æŒ `import xx {xx} from 'xx'` å³ï¼šä¸èƒ½ç®€å•çš„æŠŠ `module.exports` æ›¿æ¢æˆ `export default`
  - åœ¨ build é˜¶æ®µï¼Œåˆ™ç”± rollup çš„ @rollup/plugin-commonjs æ’ä»¶åšè½¬åŒ–
  - ğŸ‘† rollup çš„å®—æ—¨å°±æ˜¯åˆ©ç”¨ ESM çš„ tree-shaking å®ç°æœ€å°åŒ–æ‰“åŒ…åä»£ç ï¼Œå› æ­¤æœ¬èº«å°±å¿…é¡»æœ‰å®Œå–„çš„è½¬åŒ– plugin
- æ•´åˆå†…éƒ¨ä¾èµ–åˆ°1ä¸ªæ–‡ä»¶(ğŸ¤”ä¹Ÿæ˜¯ç”¨esbuildå—ï¼Ÿ)å¦‚ `import { debounce } from 'lodash-es'` ä¼šå‘å‡º 600 å¤šä¸ªæ¨¡å—è¯·æ±‚
  - ğŸ¤” æ€ä¹ˆç¡®å®šå“ªäº›æ¨¡å—å±äºä¸€ä¸ªæ¨¡å—ï¼Œnode_modulesçš„ä¾èµ–è¿˜å¥½ï¼Œå¦‚æœæ˜¯ä¸šåŠ¡ä»£ç çš„å…¬å…±å‡½æ•°ä¾èµ–ä¹Ÿä¼šè¢«æ•´åˆèµ·æ¥å—ï¼Ÿ
- ç¼“å­˜é¢„æ„å»ºçš„ç»“æœï¼Œæ›´æ–°æ—¶æœºæ˜¯ï¼šä¾èµ–å…³ç³»å‘ç”Ÿå˜åŒ–(æ–°å¼•å…¥èµ„æºæˆ–åˆ é™¤å¼•å…¥èµ„æºæˆ–ä¿®æ”¹å¼•å…¥èµ„æºè·¯å¾„)
  - ğŸ‘†å¦‚æœ ä¸šåŠ¡ä»£ç  ä¹Ÿä¼šæ•´åˆèµ·æ¥çš„ HMR æ²¡åŠæ³•åšå§ï¼Œå› ä¸ºç¼“å­˜ä½äº†è¿™ä¸ªé¢„æ„å»ºçš„ç»“æœï¼Œä¾èµ–å…³ç³»ä¹Ÿæ²¡å˜(åªæ˜¯å˜äº†å†…å®¹)
  - TODO: å»ºç«‹ä¸€ä¸ªåŸç”Ÿjsçš„viteé¡¹ç›®ï¼Œå¼•å…¥loadshå’Œæ·±å±‚æ¨¡å—çš„ä¸šåŠ¡ä»£ç ï¼ŒæŸ¥çœ‹æµè§ˆå™¨ networker

### Monorepo åœºæ™¯
bare import ä¸æ˜¯ node_modules ä¸ä¼šå˜åŒ–çš„ä¾èµ–ï¼Œè€Œæ˜¯æ­£åœ¨å¼€å‘ä¸­çš„æºç 
æ­¤æ—¶å¸Œæœ›çš„æ˜¯è¿™ä¸ªä¾èµ–ä¸è¦ç»è¿‡ é¢„ç¼–è¯‘ è€Œæ˜¯å’Œå…¶ä»–ä¸šåŠ¡ä»£ç ä¸€æ ·

ç‰¹æ®Šæƒ…å†µä¸‹ï¼ŒMonorepo çš„ä¾èµ–ä¸æ˜¯ESM (åŸºæœ¬ä¸ä¼šå§ã€‚ã€‚ã€‚)ï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®è®© vite å¯¹è¿™ä¸ª Monorepo åº“åš é¢„æ„å»º
```ts
export default defineConfig({
  optimizeDeps: {
    include: ['monorepo-dep'],
  },
  build: {
    commonjsOptions: {
      include: [/monorepo-dep/, /node_modules/],
    },
  },
})
```
é‚£ä¹ˆæ­¤æ—¶ vite å°±ä¼šæŠŠ monorepo-dep å½“ä½œ node_modules çš„ä¾èµ–å¤„ç†ï¼Œå¹¶ä¸”ç¼“å­˜
è€Œ node_modules ä¾èµ–çš„ç¼“å­˜æƒ³è¦é‡æ–° é¢„æ„å»º éœ€è¦packages.jsonä¾èµ–ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè§¦å‘
è€Œ monorepo-dep è¿˜åœ¨å¼€å‘ä¸­ï¼Œå› æ­¤æƒ³è¦ç”Ÿæ•ˆå°±åªèƒ½é‡å¯ vite æœåŠ¡ï¼Œå¹¶ä¸”å¼€å¯å¼ºåˆ¶ focus æ¨¡å¼ `pnpm dev --focus`

## é¢„æ„å»ºæ—¶æœº

- é¢„æ„å»ºå‘ç”Ÿç¼–è¯‘æ—¶
  - TODO:å¾…ç¡®è®¤ ç¼–è¯‘æ—¶æ‰«ææ‰€æœ‰ä»£ç çš„ import è¯­å¥åˆ†æå‡ºéœ€è¦é¢„æ„å»ºçš„æ¨¡å—ï¼Œå¹¶æ‰§è¡Œ
  - å½“ import è¯­å¥ï¼Œæ˜¯åœ¨è¿è¡Œæ—¶è®¿é—®åˆ°è·¯ç”±æ‰ç”Ÿæˆçš„æ—¶å€™ï¼Œæºç ä¸­æ²¡æœ‰è¿™ä¸ª importï¼Œåˆ™åœ¨å¯åŠ¨ç¼–è¯‘æ—¶ä¸ä¼š é¢„æ„å»º åˆ°
  - ğŸ‘† è‡ªåŠ¨import [unplugin-auto-import github](https://github.com/antfu/unplugin-auto-import) çš„æ’ä»¶æ˜¯è¿™ç§æƒ…å†µå—ï¼Ÿ 
  - ä½†æ˜¯è¿è¡Œæ—¶ï¼Œèƒ½ç›‘æµ‹åˆ°ç”Ÿæˆçš„ import è¯­å¥å¹¶è§¦å‘é‡æ–° æ„å»º
  - ç”¨ `optimizeDeps.include` æˆ– `optimizeDeps.exclude` é…ç½®ï¼Œæ‰‹åŠ¨æŒ‡å®šå¯åŠ¨ç¼–è¯‘æ—¶éœ€è¦é¢„ç¼–è¯‘çš„æ¨¡å—(å³ä½¿æºç ä¸­æ²¡æœ‰import)
  - exclude æ’é™¤åˆ™ç”¨äºè¿è¡Œæ—¶è§¦å‘é‡æ–° æ„å»ºï¼Œå¦‚è¿™ä¸ªæ¨¡å—æ˜¯ ESM ä¸”ä¾èµ–æ¨¡å—ä¸å¤š(é¢„æ„å»ºä¸»è¦ä½œç”¨å‘æŒ¥ä¸äº†)æ—¶ï¼Œå¯ä»¥æ’é™¤æ‰ï¼Œçœå»è¿™æ¬¡é‡æ–° æ„å»º
- è¿è¡Œæ—¶åªè´Ÿè´£ç›‘å¬æ˜¯å¦éœ€è¦é‡æ–° æ„å»º - ğŸ¤” è¿è¡Œæ—¶è§¦å‘é‡æ–°æ„å»ºç›¸å½“äºé‡å¯ vite å—ï¼Ÿé¡µé¢ä¸ä¼š reload ï¼Ÿ

> é‡æ–°æ„å»º !== é‡æ–°é¢„æ„å»º
> re-bundle !== re-run pre-bundle

## é‡æ–°é¢„æ„å»ºæ—¶æœº

### vite è‡ªåŠ¨è§¦å‘
ä¹Ÿå°±æ˜¯ æ›´æ–°é¢„æ„å»ºç¼“å­˜çš„æ—¶æœº
- Package manager lockfile content, e.g. `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml` or `bun.lockb`
- Patches folder modification time ğŸ¤” è¡¥ä¸æ–‡ä»¶å¤¹ï¼Ÿï¼Ÿï¼Ÿ
- Relevant fields in your `vite.config.js`, if present.
- `NODE_ENV` value.

### æ‰‹åŠ¨è§¦å‘

- `pnpm dev --force`
- åˆ é™¤ `node_modules/.vite/` ç›®å½•ï¼Œåé‡å¯ vite

### ç¼“å­˜å¸¦æ¥çš„ç‰¹æ®Šæ“ä½œ

å› ä¸º node_modules è§†ä¸ºä¸å˜åŒ–çš„æ¨¡å—ï¼Œç»è¿‡ é¢„æ„å»º ä¹‹åé™¤äº†åœ¨é¡¹ç›®ç›®å½• nodejs ç¯å¢ƒæœ‰ç¼“å­˜ä¹‹å¤–
viteDevServer ä¸ºè¿™ä¸ªèµ„æºåšäº†æµè§ˆå™¨ HTTP å¼ºç¼“å­˜å’Œ url-query hashï¼Œåªæœ‰è§¦å‘ re-run pre-bundle æ‰ä¼šæ›´æ–°åˆ°è¿™äº›æµè§ˆå™¨å¼ºç¼“å­˜çš„èµ„æº url-query hash
å¦‚æœå¸Œæœ›ç›´æ¥ä¿®æ”¹ node_modules ä¸­çš„ä»£ç æ¥è°ƒè¯•é¡¹ç›®ï¼ˆæ­¤æ—¶ä¸ä¼šè§¦å‘è‡ªåŠ¨ re-run pre-bundle)
å› æ­¤éœ€è¦æ‰‹åŠ¨é‡å¯ vite è§¦å‘ focusï¼Œå¹¶æ¸…é™¤æµè§ˆå™¨ç¼“å­˜(ğŸ¤” æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æ˜¯å› ä¸ºæ­¤æ—¶çš„hashä¸ä¼šå˜ï¼Ÿç”Ÿæˆhashçš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿpackage.json å—) 


## ç›¸å…³é…ç½®é¡¹
[viteå®˜æ–¹æ–‡æ¡£config - Dep Optimization Options](https://vitejs.dev/config/dep-optimization-options.html#optimizedeps-include)

viteåœ¨å¯åŠ¨ `listen` çš„æ—¶å€™ï¼Œå…ˆæ‰§è¡Œ 1. esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å• 2. esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶ï¼Œæ‰ä¼šå¯åŠ¨æœåŠ¡

æ‰€ä»¥è™½ç„¶è¯´ `vite` è¯´devé˜¶æ®µéƒ½æ˜¯æ‡’åŠ è½½å¯åŠ¨æ²¡æœ‰æ‰“åŒ…æ­¥éª¤ï¼Œå…¶å®æ˜¯é”™çš„
æ—¢ç„¶ `esbuild` å¯ä»¥å®ç°æ‰“åŒ…ï¼Œé‚£ buildé˜¶æ®µ ä¸ºä»€ä¹ˆä¸å¹²è„†ç”¨ `esbuild`ï¼Œè€Œæ˜¯ç”¨ `rollup`
å®˜æ–¹æ–‡æ¡£ä¹Ÿè§£é‡Šäº† `esbuild` ç›®å‰æ‰“åŒ…åŠŸèƒ½è¿˜ä¸å®Œå–„ï¼Œä¸åƒ `rollup` åŸºæœ¬ä»€ä¹ˆéƒ½èƒ½æ‰“åŒ…


## 
åˆ›å»ºé¡¹ç›®

ğŸ‘‡ `esbuild_pre_bundle/serve.js`
```js
import Koa from 'koa'
import koaStatic from 'koa-static'
import { fileURLToPath, URL } from 'node:url' // ç”¨äºé…ç½®ç›®å½•åˆ«å

const app = new Koa()

// é™æ€èµ„æº
app.use(koaStatic(fileURLToPath(new URL('.', import.meta.url))))

app.listen(3001, () => {
  console.log('build success')
})
```

```html
<!DOCTYPE html>
<html>
<head><title>esbuild pre bundle</title></head>
<body>
  <script type="module" src="./index.js"></script>
</body>
</html>
```

```js
// index.js
import { a } from './src/a.js'
console.log(a)

// a.js
export * from './a_1.js'
// a_1.js
export * from './a_1_1.js'
// a_1_1.js
export const a = 'a_1_1'
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104155749.png)


```js
// import { a } from './src/a.js'
import { throttle } from 'lodash-es'

console.log(throttle)
```

> Uncaught TypeError: Failed to resolve module specifier "lodash-es". Relative references must start with either "/", "./", or "../".
> ğŸ‘† esm ä¸æ”¯æŒ bare improt

```html
<!DOCTYPE html>
<html>
<head><title>esbuild pre bundle</title></head>
<body>
  <script type="importmap">
    {
      "imports": {
        "lodash-es": "/node_modules/lodash-es/lodash.js"
      }
    }
  </script>
  <script type="module" src="./index.js"></script>
</body>
</html>
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104160950.png)

### Vanilla Vite

ä¸ä¼šåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104161944.png)

lodash-es ä¼šåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104162153.png)

## esbuildçš„æ‰«ææ·±å±‚ä¾èµ–æ¸…å•

```js
async function scanImports() {
  // ç¡®è®¤å…¥å£ï¼Œè¿™é‡Œå†™æ­»ä¸æ”¯æŒé…ç½®ï¼Œä¹Ÿä¸æ”¯æŒå¤šå…¥å£
  const entry = './index.js'
  
  // åˆ›å»º esbuildScanPlugin æ’ä»¶
  const depImports = {} // keyä¸º bare import, value ä¸º absolute url
  const plugin = createEsbuildScanPlugin(depImports)

  await build({
    absWorkingDir: process.cwd(),
    write: false,
    entryPoints: [entry], // ä¼ å…¥å…¥å£
    bundle: true,
    format: 'esm',
    logLevel: 'error',
    plugins: [plugin], // Vite æ”¯æŒé…ç½®å…¶ä»–æ’ä»¶
    // outfile: 'dist.js',
    allowOverwrite: true,
  })
  return {depImports}
}
```

```js
/**
 * esbuild çš„ plugin ä¹Ÿæ˜¯å®šä¹‰ä¸€ä¸ªåŒ…å« name å’Œ setup å‡½æ•°çš„å¯¹è±¡
 * setupå‡½æ•°ä¼šè¢« esbuild æ³¨å…¥ä¸€ä¸ª build å¯¹è±¡å‚æ•°ï¼Œå¾€è¿™é‡Œé¢æŒ‚è½½ä¸œè¥¿å°±èƒ½è‡ªå®šä¹‰ esbuild çš„å¤„ç†é€»è¾‘
 */
function createEsbuildScanPlugin(depImports) {
  return {
    name: 'dep-scan',
    setup(build) {
      build.onResolve({ filter: /^[\w@][^:]/ }, async ({ path, importer }) => {
        
        // è·å– ç¬¬ä¸‰æ–¹æ¨¡å—çš„ç»å¯¹è·¯å¾„
        // const resolved = await resolve(path, importer)
        const afterUrl = fileURLToPath(new URL('./node_modules/lodash-es/lodash.js', import.meta.url))
        console.log('dep-scan check this', path,afterUrl)
        
        const resolved = path === 'lodash-es' ? afterUrl : path
        // ERROR: Plugin "dep-scan" returned a non-absolute path: lodash-es (set a namespace if this is not a file path)
        // åªå¯¹ node_modules ç›®å½•ä¸‹çš„æ¨¡å—ç”¨ esbuild å¤„ç†
        if (resolved && resolved.includes('node_modules')) {
          // è®°å½• pre-bundle æ¸…å•
          // ğŸ¤” TODO: å¦‚æœåªæ˜¯ä¸ºäº†è®°å½•æ¸…å•ç»™åé¢çš„esbuild è½¬è¯‘ï¼Œ ä¸ºä»€ä¹ˆè¿˜è¦è®¾ç½® trueï¼Œè½¬è¯‘æ­¥éª¤æœ¬èº«å°±ä¼šè¾“å‡ºç›¸åº”çš„æ–‡ä»¶å§
          // æ‰«æè¿™ä¸€æ­¥ä¸»è¦æ˜¯å¤„ç†å…¶ä»–åç¼€æ–‡ä»¶çš„å§ï¼Œæ•´åˆæ‰“åŒ…ä¸»è¦è¿˜æ˜¯é åé¢ä¸€æ­¥
          depImports[path] = resolved

          // è¿™é‡Œåªæ˜¯ä¸ºäº†è¿”å› external: true é€‰é¡¹
          return {
            path, // æ¨¡å—è·¯å¾„
            external: true, // å…¥å£æ–‡ä»¶å¤–çš„å±äº node_modules çš„æ¨¡å—è®¾ç½®ä¸º true
          }
        }
      })
    },
  }
}
```

## esbuildå¯¹æ·±åº¦æ¨¡å—æ•´åˆæˆ1ä¸ªæ–‡ä»¶


```js
async function doBuild({depImports}) {
  // esubild çš„åŒä¸€ä¸ª api build å‚æ•°åŠ ä¸Š metafile: true å¯ä»¥å¾—åˆ° res.metafile
  const result = await build({
    absWorkingDir: process.cwd(),
    entryPoints: Object.keys(depImports),
    bundle: true, // è¿™é‡Œä¸º trueï¼Œå¯ä»¥å°†æœ‰è®¸å¤šå†…éƒ¨æ¨¡å—çš„ ESM ä¾èµ–å…³ç³»è½¬æ¢ä¸ºå•ä¸ªæ¨¡å—
    format: 'esm',
    // target: config.build.target || undefined,
    // external: config.optimizeDeps?.exclude, // é…ç½®é¡¹ æ’é™¤é¢„ç¼–è¯‘
    logLevel: 'error',
    splitting: true,
    sourcemap: true,
    outdir: fileURLToPath(new URL('./dist', import.meta.url)),
    platform: 'browser',
    ignoreAnnotations: true,
    metafile: true,
    // define, // ç¯å¢ƒå˜é‡è½¬çœŸå®å€¼å­—ç¬¦ä¸²
    plugins: [],
  })
  // console.log('res.metafile', result.metafile)
}
```

```js
await doBuild(await scanImports())
```


![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104191005.png)

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104191236.png)


æ‰‹åŠ¨ä¿®æ”¹å¼•ç”¨ä¸º `import { throttle } from './dist/lodash-es.js'`(ä¸ä¼šå‘½ä¸­ æ”¶é›†ä¾èµ–æ¸…å•çš„é€»è¾‘ï¼Œå› æ­¤ä¸ä¼šé‡å¤æ‰“åŒ…)
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230104191625.png)

## è¯·æ±‚è·¯å¾„æ˜ å°„

bare import è¯·æ±‚ä¼šè¢«viteè·¯ç”±æ‹¦æˆªé‡å†™ä¸ºè®¿é—®é¢„æ„å»ºç›®å½•çš„ç›¸åº”èµ„æº

è¿™ä¸€æ­¥ä¸éš¾å®ç°
å› ä¸ºå·²ç»æ”¶é›†åˆ°äº†: keyä¸º bare import, valueä¸ºå®Œæ•´è·¯å¾„ çš„ä¾èµ–æ¸…å• 

éš¾çš„æ˜¯è¦ç»™è¿™ä¸ªè®¿é—®è®¾ç½® qurey hash å¹¶ä¸”èƒ½æ›´æ–°

## ç¼“å­˜åŠæ›´æ–°é€»è¾‘



## å‚è€ƒèµ„æ–™

- [èŠä¸€èŠ Vite çš„é¢„æ„å»ºå’ŒäºŒæ¬¡é¢„æ„å»º](https://juejin.cn/post/7125424862050402341)
- [Vite æºç ï¼ˆå…«ï¼‰Vite çš„é¢„æ„å»ºåŸç†](https://juejin.cn/post/7047479540850884645)