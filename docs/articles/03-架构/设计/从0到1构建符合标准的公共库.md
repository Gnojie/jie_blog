[toc]

- æ€ä¹ˆæ‰“åŒ…ç»„ä»¶åº“
- æ€ä¹ˆåŸºäºç»„ä»¶åº“æ‰“åŒ…è‡ªå·±çš„ç»„ä»¶åº“

## å‰æœŸå‡†å¤‡
åˆ›å»ºç›®å½•
```bash
mkdir animal-api
cd animal-api
npm init -y
```

åˆ›å»ºå…¬å…±åº“æ–‡ä»¶index.js
```js
import axios from 'axios';
function getCat() {
  return axios.get('https://aws.random.cat/meow').then(res=>{
    return {
      imageSrc: res.data.file,
      text: 'CAT'
    }
  })
}
export default {
  getCat
}
```


## å•å…ƒæµ‹è¯•å…¬å…±åº“
å®‰è£…[jestå•å…ƒæµ‹è¯•](https://www.jestjs.cn/docs/getting-started)
```bash
yarn add -D jest
```

åˆ›å»ºå•å…ƒæµ‹è¯•è„šæœ¬æ–‡ä»¶åœ¨testæ–‡ä»¶å¤¹ä¸‹`index.test.js`
```js
import animalApi from '../index'
describe('animal-api', () => {
  it('get cat func', () => {
    return animalApi.getCat().then(res => {
      expect(res.imageSrc).not.toBeUndefined();
      expect(res.text).toEqual('CAT');
    })
  })
})
```
ç›´æ¥è¿è¡Œ `npx jest` æˆ–è€…
åˆ°`package.json` ä¸­æ·»åŠ `script`è„šæœ¬ `"test": "jest"`
è¿è¡Œç»“æœï¼š
; ![jestæŠ¥é”™](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/jest1.png)
ğŸ‘† å¯ä»¥çœ‹å‡ºæŠ¥é”™ä¿¡æ¯æ˜¯æŒ‡æµ‹è¯•è„šæœ¬å¼•å…¥index.jsä¸æ”¯æŒä½¿ç”¨esm
[jestå®˜æ–¹æ–‡æ¡£](https://www.jestjs.cn/docs/getting-started#%E4%BD%BF%E7%94%A8-babel)ä¸­æœ‰ä»‹ç»ä½¿ç”¨babelä½¿è¿è¡Œjestè¯†åˆ«esmçš„æ–¹æ³•

```bash
yarn add --dev babel-jest @babel/core @babel/preset-env
```

åˆ›å»º`babel.config.js`
```js
// babel.config.js
module.exports = {
  presets: [['@babel/preset-env', {targets: {node: 'current'}}]],
};
```

æ­¤æ—¶è¿è¡Œ `npx jest`

; ![å…¬å…±åº“æ–¹æ³•æŠ¥é”™](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/jest2.png)
æ­¤æ—¶çš„æŠ¥é”™æ˜¯index.jsçš„å…¬å…±åº“æ–¹æ³•æŠ¥é”™ï¼Œç¼ºå°‘axios
```bash
yarn add axios
```
æ³¨æ„axiosæ˜¯ç”Ÿäº§ç¯å¢ƒä¹Ÿéœ€è¦çš„åº“ï¼Œæ‰€ä»¥ä¸åŠ  `-D`
å†æ¬¡æ‰§è¡Œ`npx jest`
; ![å•å…ƒæµ‹è¯•è„šæœ¬è¾“å‡ºç»“æœ](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/jest3.png)
æˆåŠŸè¿è¡Œå•å…ƒæµ‹è¯•ï¼Œå¹¶ä¸”å•å…ƒæµ‹è¯•çš„ç»“æœä¹Ÿæ˜¯æˆåŠŸ

## è®©å…¬å…±åº“å¯ä»¥åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹è¿è¡Œ
> æµè§ˆå™¨ä½¿ç”¨ç›´æ¥ä½¿ç”¨npmç¬¬ä¸‰æ–¹åº“çš„æ–¹å¼æ˜¯é€šè¿‡`<script src="">`æ¥å¼•å…¥çš„(ç±»ä¼¼CDN),æˆ–è€…é€šè¿‡jsåŠ¨æ€åˆ›å»º`<script>`æ¥å¼•å…¥ã€‚

### UMDæ¨¡å—åŒ–
é’ˆå¯¹æµè§ˆå™¨é€šè¿‡`<script>æ ‡ç­¾`å¼•å…¥çš„æ–¹å¼ï¼Œç¬¬ä¸‰æ–¹åº“ä¸€èˆ¬ä¼šæ˜¯UMDçš„æ¨¡å—åŒ–æ–¹å¼(åŒæ—¶æ”¯æŒAMDã€CJSã€å…¨å±€å˜é‡)
å¦‚ä¸‹æ˜¯`jQuery`åº“çš„UMDæ¨¡å¼
```js
(function (root, factory) {
if (typeof define === 'function' && define.amd) {
  // AMD
  define(['jquery'], factory);
} else if (typeof exports === 'object') {
  // CommonJS
  module.exports = factory(require('jquery'));
} else {
  // æµè§ˆå™¨å…¨å±€å˜é‡(root å³ window)
  root.returnExports = factory(root.jQuery);
}}(this, function ($) {
  // ä¸šåŠ¡ä»£ç 
}));
```
ğŸ‘† ä¸€ä¸ªè‡ªæ‰§è¡Œå‡½æ•°ï¼ŒæŠŠä¸šåŠ¡ä»£ç ä½œä¸ºå›è°ƒå‡½æ•°ï¼Œä¼ å…¥æ¨¡å—åŒ–å¤„ç†çš„å…¬å…±ä»£ç ä¸­

### ç”¨babelä½¿å…¬å…±åº“ä»¥UMDå½¢å¼è¾“å‡º

ä½¿ç”¨babelæ’ä»¶[@babel/plugin-transform-modules-umd](https://babel.docschina.org/docs/en/babel-plugin-transform-modules-umd/) è½¬è¯‘ä»£ç è¾“å‡ºæˆæ–°æ–‡ä»¶(æ³¨æ„è¿™é‡Œè¿˜ä¸æ¶‰åŠæ‰“åŒ…)

éœ€è¦é€šè¿‡åœ¨nodejsç¯å¢ƒè¾“å‡ºæ–‡ä»¶å°±éœ€è¦ç”¨åˆ°`@babel/cli`äº†ï¼Œä¹‹å‰ä¸éœ€è¦æ˜¯å› ä¸º`babel-jest`ï¼Œåªéœ€è¦åœ¨è¿è¡Œæ—¶è½¬è¯‘å¹¶è¿è¡Œå³å¯ï¼Œä¸éœ€è¦è¾“å‡ºè½¬è¯‘åçš„æ–‡ä»¶ã€‚

æ‰€ä»¥ä½¿ç”¨`babel plugin` è¾“å‡ºè½¬è¯‘åæ–‡ä»¶è¿˜éœ€è¦`@babel/cli`

1. å®‰è£…babelç›¸å…³ä¾èµ–
```bash
yarn add -D @babel/cli @babel/plugin-transform-modules-umd
```
å‰é¢å·²ç»å®‰è£…äº†`@babel/core`äº†ï¼Œè¿™æ¬¡ä¸ç”¨é‡å¤å®‰è£…äº†

2. é…ç½®babelæ’ä»¶plugins
åœ¨`babel.config.js`ä¸­é…ç½®
```js
module.exports = {
  presets: [ ... ],
  plugins: ['@babel/plugin-transform-modules-umd']
}
```
3. è¿è¡ŒbabelæŒ‡ä»¤è¾“å‡ºæ–‡ä»¶

ç›´æ¥è¿è¡Œ`npx babel index.js --out-dir dist`
æˆ–è€…æŠŠè„šæœ¬é…ç½®åˆ°`package.json`ä¸­ `"build": "babel index.js --out-dir dist"`

**è¿è¡Œç»“æœï¼š**
; ![babel output](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/babel1.png)

**è¾“å‡ºè½¬è¯‘åæ–‡ä»¶ï¼š**
; ![babelè½¬è¯‘åä»£ç ](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/babel2.png)

**ç²¾ç®€åè½¬è¯‘åä»£ç ï¼š**
```js
(function (global, callback) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "axios"], callback); // AMD - æ ¹æ®æ˜¯å¦å…¨å±€æœ‰defineæ–¹æ³•
  } else if (typeof exports !== "undefined") {
    callback(exports, require("axios")); // CJS - æ ¹æ®æ˜¯å¦æ”¯æŒ exportså®ä¾‹
  } else {
    var mod = { exports: {} };
    callback(mod.exports, global.axios); // è°ƒç”¨ä¸šåŠ¡ä»£ç callbackï¼Œéœ€è¦ä¼ é€’ä¸šåŠ¡ä»£ç å¼•ç”¨çš„ä¾èµ–ï¼ŒğŸ‘†cjsã€amdåŒç†ï¼Œä¼ å…¥exportså’Œaxios
    global.index = mod.exports; // å…¨å±€å˜é‡
  }
})(typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this),
  // ğŸ‘† æ ¹æ®ç¯å¢ƒå¤„ç†å…¨å±€å˜é‡çš„this
  function () {
  //  ä¸šåŠ¡ä»£ç 
});
```
ğŸ‘† å¯ä»¥çœ‹å‡ºUMDè¾“å‡ºçš„ä»£ç å¾ˆåƒ`webpack`æ‰“åŒ…åçš„ä»£ç 

```js
function (_exports, _axios) {
  "use strict";
  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.default = void 0;
  _axios = _interopRequireDefault(_axios);
  function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
  function getCat() {
    return _axios.default.get('https://aws.random.cat/meow').then(res => {
      return {
        imageSrc: res.data.file,
        text: 'CAT'
      };
    });
  }
  var _default = {
    getCat
  };
  _exports.default = _default;
});
```
ğŸ‘† ä¸šåŠ¡ä»£ç ä¸­çš„æ¨¡å—åŒ–ä¼šè¢«å¤„ç†ä¸ºï¼Œæ ¹æ®ç¯å¢ƒå†³å®šä¼ å…¥çš„`_exports`å‚æ•°ï¼Œè€Œä¸Šé¢ç²¾ç®€ä»£ç å¯ä»¥çœ‹å‡º`callback`éƒ¨åˆ†ï¼Œ`amd`é `define`ä¼ å…¥å‚æ•°ï¼Œ`cjs`ç›´æ¥ä½¿ç”¨ç¯å¢ƒæ”¯æŒ`exports`ã€`å…¨å±€å˜é‡`åˆ™ä¼ å…¥ç©ºå¯¹è±¡è®©ä»£ç æ‰§è¡Œçš„æ—¶å€™ä¸æŠ¥é”™è€Œå·²(ä½¿ç”¨ä¾èµ–å…¨é å„ç§åº“çš„å…¨å±€å˜é‡)

### åˆ°æµè§ˆå™¨æµ‹è¯•è½¬è¯‘åUMDæ–‡ä»¶çš„è¿è¡Œç»“æœ
æ–°å»ºhtmlæ–‡ä»¶ï¼š
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>animal-api</title>
</head>
<body>
  <header>æµ‹è¯•æµè§ˆå™¨ç¯å¢ƒanimal-api</header>
  <div id="imageSrc"></div>
  <div id="text"></div>

  <script src="./dist/index.js"></script>
  <script>
    animalApi.getCat().then(res=>{
      document.querySelector('#imageSrc').textContent = res.imageSrc
      document.querySelector('#text').textContent = res.text
    })
  </script>
</body>
</html>
```
è¿è¡Œç»“æœï¼š
; ![æµè§ˆå™¨ç¯å¢ƒç»“æœ](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/babel3.png)
ğŸ‘† æ‰¾ä¸åˆ°animalApiå˜é‡
æŸ¥çœ‹è½¬è¯‘åæºç ï¼Œå¯ä»¥çœ‹å‡º`global.index = mod.exports; // å…¨å±€å˜é‡`ï¼Œå¯¼å‡ºçš„å…¬å…±åº“æŒ‚è½½åœ¨å…¨å±€çš„indexä¸‹

æˆ‘ä»¬éœ€è¦æŒ‡å®šæŒ‚è½½çš„å˜é‡ä¸ºæˆ‘ä»¬è®¾ç½®çš„åå­—ï¼Œå¦‚ä¸‹
[babel-plugin-transform-modules-umdçš„exactGlobalsé…ç½®](https://babel.docschina.org/docs/en/babel-plugin-transform-modules-umd/#with-a-configuration-file-recommended)
; ![babelå…¨å±€å˜é‡é…ç½®](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/babelå…¨å±€å˜é‡é…ç½®.png)


æ”¹å†™pluginæ’ä»¶é…ç½®
```js
plugins:[
  ['@babel/plugin-transform-modules-umd',{
    "globals": {
      "index": "animalApi",
    },
    "exactGlobals": true
  }]
]
```

é‡æ–° `yarn build`
ğŸ‘‡ ä¸åŒçš„åœ°æ–¹
```js
if() {
  // ...
} else {
  var mod = {
    exports: {}
  };
  callback(mod.exports, global.axios);
  global.animalApi = mod.exports; // å…¨å±€å˜é‡æŒ‚åœ¨åˆ°äº†babelè®¾ç½®çš„å˜é‡ä¸‹ï¼Œä¸å†æ˜¯index
}
```

åˆ·æ–°æµè§ˆå™¨ç»“æœï¼š
; ![æµè§ˆå™¨ç¯å¢ƒç»“æœ2](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/babel4.png)
ğŸ‘† animalApiæ‰¾åˆ°äº†ï¼Œä½†æ˜¯`getCat`æ–¹æ³•æ²¡æ‰¾åˆ°ï¼Œå†æŸ¥çœ‹æºç æˆ–è€…æ‰“æ–­ç‚¹å¯çŸ¥`global.animalApi = mod.exports`çš„exportæ˜¯ä¸ª`default`
å› æ­¤htmlå¤„è°ƒç”¨æ”¹ä¸º`animalApi.default.getCat().then()`

åˆ·æ–°æµè§ˆå™¨ç»“æœï¼š
; ![æµè§ˆå™¨ç¯å¢ƒç»“æœ3](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/babel5.png)
ğŸ‘† èƒ½è¿è¡Œåˆ°æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç é‡Œé¢ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°axios
ç”±æ­¤å¯çŸ¥babelè™½ç„¶å¯ä»¥å¸®æˆ‘ä»¬å¤„ç†æ¨¡å—åŒ–è½¬è¯‘ï¼Œä½†æ˜¯ä¸ä¼šå¸®æˆ‘ä»¬å¤„ç†ç¬¬ä¸‰æ–¹åº“çš„æ¨¡å—åŒ–ã€‚ä¸ºäº†å¤„ç†ç¬¬ä¸‰æ–¹åº“ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°æ‰“åŒ…å·¥å…·`webpack`

### webpackå¤„ç†ç¬¬ä¸‰æ–¹ä¾èµ–
ç”¨webpackè¾“å‡ºæ–‡ä»¶çš„è¯ï¼Œä¸ºä»€ä¹ˆä¸æŠŠbabelé…ç½®åˆ°webpackçš„loaderé‡Œï¼Œè€Œåªæ˜¯ç”¨webpackå¤„ç†ä¾èµ–è¿™ä¹ˆæµªè´¹?

1. å®‰è£…webpakcç›¸å…³ä¾èµ–
```bash
yarn add -D webpack webpack-cli
```

2. åˆ›å»ºwebpacké…ç½®æ–‡ä»¶`webpack.config.js`
```js
const path = require('path');
module.exports = {
  entry: './index.js',
  output: {
    path: path.resolve(__dirname,'lib'),
    filename: 'index.js', // é»˜è®¤main.js
    library: 'animalApi',
    libraryTarget: 'var' // var this window umd
  }
}
```
[webpack-libarayå®˜æ–¹æ–‡æ¡£](https://www.webpackjs.com/guides/author-libraries/)

- å˜é‡ï¼šä½œä¸ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œé€šè¿‡ script æ ‡ç­¾æ¥è®¿é—®ï¼ˆlibraryTarget:'var'ï¼‰
- thisï¼šé€šè¿‡ this å¯¹è±¡è®¿é—®ï¼ˆlibraryTarget:'this'ï¼‰ã€‚
- windowï¼šé€šè¿‡ window å¯¹è±¡è®¿é—®ï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼ˆlibraryTarget:'window'ï¼‰
- UMDï¼šåœ¨ AMD æˆ– CommonJS çš„ require ä¹‹åå¯è®¿é—®ï¼ˆlibraryTarget:'umd'ï¼‰

3. è¿è¡Œwebpack

`npx webpack`
æˆ–è€…é…ç½®`package.json`ä¸­çš„`"build": "webpack"`
æŸ¥çœ‹webpackç¼–è¯‘åæ–‡ä»¶æ˜¯ä¸€å¤§å¨ä»£ç 

1. ä¿®æ”¹htmlå¼•å…¥èµ„æºè·¯å¾„

ç”±åŸæ¥å¼•å…¥babelè½¬è¯‘åæ–‡ä»¶ä¿®æ”¹ä¸ºwebpackç¼–è¯‘åæ–‡ä»¶
`<script src="./lib/index.js"></script>`

**è¿è¡Œç»“æœï¼š**
; ![webpackæµè§ˆå™¨è¿è¡Œç»“æœ](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/webpack1.png)

ç›´æ¥ä½¿ç”¨webpackç¼–è¯‘åçš„å…¬å…±åº“å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å‰é¢è‡ªå·±æè¿™ä¹ˆå¤šbabelæ˜¯æ²¡æœ‰ç”¨çš„ï¼Ÿå› ä¸ºæ‰§è¡Œçš„webpackæ ¹æœ¬å°±æ²¡æœ‰å»æ‰§è¡Œbabelç›¸å…³çš„ä¸œè¥¿

ä¸å¯¹ babelé…ç½®è¿˜è¦ç»™jestç”¨çš„ï¼Œè¿è¡Œjestä¼šè‡ªåŠ¨æ ¹æ®`babel-jest`å»ä½¿ç”¨babelè½¬è¯‘ä»£ç 

æ˜¯è¿™ä¸¤ä¸ªğŸ‘‡ babelç›¸å…³çš„ä¸œè¥¿ä¸éœ€è¦äº†
`@babel/cli @babel/plugin-transform-modules-umd`

è¿è¡ŒæŒ‡ä»¤ç§»é™¤ä¾èµ–ï¼š`yarn remove @babel/cli @babel/plugin-transform-modules-umd`
åˆ é™¤`babel.config.js`ä¸­çš„`plugins`é…ç½®

æƒ³è¦å›çœ‹è¿™äº›babelä»£ç ï¼Œçœ‹ä»£ç æäº¤è®°å½•å³å¯ï¼Œè¿™é‡Œç›´æ¥åˆ é™¤ï¼Œä¸åšä¿ç•™ï¼Œæ‰€ä»¥`package.json`ä¸­çš„é‚£æ®µbabelè¾“å‡ºå°†å¤±æ•ˆ

## è®©å…¬å…±åº“åœ¨nodejsç¯å¢ƒä¸‹è¿è¡Œ

> ä¸Šé¢å·²ç»å®ç°äº†æµè§ˆå™¨ç¯å¢ƒè¿è¡Œå…¬å…±åº“å’Œjestå•å…ƒæµ‹è¯•è¿è¡Œ

è€Œåœ¨nodejsç¯å¢ƒä¸‹è¿è¡Œï¼Œå’ŒhtmlåŒç†ï¼Œæ–°å»ºä¸€ä¸ª`nodetest.js`æ–‡ä»¶
è°ƒç”¨animalApiçš„getCatæ–¹æ³•
ç›´æ¥è¿è¡Œnodeä¼šä¸æ”¯æŒesmï¼Œå¼•ç”¨umdç¼–è¯‘åæ–‡ä»¶å³å¯æ­£å¸¸ä½¿ç”¨

æ‰€ä»¥è®©å…¬å…±åº“åœ¨nodejsç¯å¢ƒä¸‹è¿è¡Œå¹¶ä¸éœ€è¦å†åšä»€ä¹ˆï¼Œåªè¦ä½¿ç”¨æ–¹å¼•ç”¨çš„æ˜¯webpackç¼–è¯‘åçš„æ–‡ä»¶å³å¯


---

## æŒ‰éœ€åŠ è½½/å¼‚æ­¥åŠ è½½/æ‡’åŠ è½½

åŒºåˆ†æŒ‰éœ€åŠ è½½å’ŒæŒ‰éœ€æ‰“åŒ…çš„æ¦‚å¿µ
è¿è¡Œæ—¶(æµè§ˆå™¨)ã€ç¼–è¯‘æ—¶(webpack)
import()ã€tree-shaking
es6æ”¯æŒæˆ–è€…`scriptæ ‡ç­¾`å®ç° ã€é babelå®ç°ï¼Ÿè¯†åˆ«ASTä¸­çš„å¼•å…¥è¯­æ³•import/requireè½¬åŒ–ä¸ºæŒ‰éœ€å¤„ç†ä¾èµ–å†…å®¹

æ€è€ƒğŸ¤”ï¼šè¦å®ç°æŒ‰éœ€åŠ è½½èµ„æºï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æ˜¯ä¸€ç§å·¥å…·æ–¹æ³•ï¼Œé€šè¿‡æ’å…¥`script`æ ‡ç­¾ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºï¼Œå¦‚ä¸‹ï¼š
```js
function loadJS(url) {
  const s = document.createElement("script");
  s.type = "text/javascript";
  s.src = url
  document.head.appendChild(s)
}
```
ğŸ‘‡ é€šè¿‡promiseå®ç°ç­‰åˆ°åŠ è½½å®Œæˆ
```js
function loadJS(url) {
  return new Promise((resolve,reject)=>{
    const s = document.createElement("script");
    s.type = "text/javascript";
    s.src = url
    s.onload=()=>{
      resolve()
    }
    s.onerror:()=>{
      reject()
    }
    document.head.appendChild(s)
  })
}
```
ä½†æ˜¯è¿™ç§æ–¹å¼æ— æ³•è·å–åˆ°æŒ‰éœ€åŠ è½½çš„èµ„æºå†…å®¹å’Œæ¨¡å—åŒ–`export`å‡ºæ¥çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬æœŸæœ›å¯ä»¥awaitå‡ºæŒ‰éœ€åŠ è½½èµ„æºçš„å†…å®¹(ç›®å‰åªèƒ½awaitåˆ°åŠ è½½çŠ¶æ€è€Œå·²)


> import() æ˜¯ä¸ªfunction likeçš„è¯­æ³•å½¢å¼
> classä¸­çš„super() ä¹Ÿæ˜¯function likeè¯­æ³•
> function like å¹¶éç»§æ‰¿ Function.prototypt ,æ— æ³•ä½¿ç”¨import.call()ç­‰è¯­æ³•
> åŒç†å¹¶éç»§æ‰¿ Object.prototypt ,æ— æ³•ä½¿ç”¨Objectæ„é€ å‡½æ•°


ç”¨functionä»¿å†™ä¸€ä¸ªimport(),[polyfillsæ¨¡å—åŠ è½½ç¤¾åŒºå‡†å¤‡äº†ä¸€ä¸ªimportModuleå‡½æ•°è§£å†³æ–¹æ¡ˆ](https://github.com/tc39/proposal-dynamic-import#using-host-specific-mechanisms)
è¿™ä¸ªè§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šæ¼æ´ï¼Œä»…ä¾›å‚è€ƒ
```js
function miniImport(url) {
  // è¿”å›promise
  return new Promise((resolve,reject)=>{
    // 1. åˆ›å»ºscriptæ ‡ç­¾
    const scriptTag = document.createElement('script');
    scriptTag.type = 'module'; // ç”¨esmåŠ è½½js

    // 2. ç”Ÿæˆéšæœºå˜é‡å Number.toStringæ•°å­—åˆ°å­—ç¬¦ä¸²çš„è½¬æ¢çš„åŸºæ•°(ä»2åˆ°36) substringç¬¬2ä½å¾€å
    const tempGlobal = '__tempModuleLoadingVariable' + Math.random().toString(32).substring(2) // ...lv2ka6rv2l8
    // 3. jsæ–‡ä»¶ç”¨esm å»å¼•æŒ‰éœ€åŠ è½½çš„èµ„æº è€Œä¸æ˜¯ç›´æ¥é€šè¿‡scriptå¼•æŒ‰éœ€åŠ è½½çš„èµ„æº,å¹¶å­˜å…¥ä¸´æ—¶å…¨å±€å˜é‡ä¸­
    scriptTag.textContent=`
      import * as item from "${url}";
      window.${tempGlobal} = item;
    `
    // 4. å¤„ç†å¼•å…¥æˆåŠŸå¤±è´¥çš„promiseè¿”å› å¹¶ä¸”è¾“å‡ºæŒ‰éœ€åŠ è½½èµ„æºå†…å®¹ï¼Œåˆ é™¤scriptæ ‡ç­¾å’Œjs esmç›¸å…³çš„å˜é‡
    scriptTag.onload=()=>{
      resolve(window[tempGlobal]);
      delete window[tempGlobal];
      scriptTag.remove();
    }
    scriptTag.onerror=()=>{
      reject(new Error('failed to load module script with URL'+url));
      delete window[tempGlobal];
      scriptTag.remove();
    }
    // 5. æŠŠscriptæ’å…¥htmlï¼Œå³å¼€å§‹æ‰§è¡Œscriptçš„æ–‡ä»¶å†…å®¹
    document.documentElement.appendChild(scriptTag)
  })
}
```
æ€è·¯æ˜¯é€šè¿‡ä¸€ä¸ªscriptæ ‡ç­¾å¼•å…¥æ–‡ä»¶å†…å®¹æ˜¯esmå¼•å…¥èµ„æº(å¯ä»¥æ‹¿åˆ°èµ„æºå†…å®¹)çš„jså½¢å¼
å› ä¸ºimport()ä¼šåŠ è½½ä¸åŒçš„èµ„æºï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¸ä¼šæœ‰å…¬ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°windowçš„å…¨å±€å˜é‡æ¥æš‚å­˜
å¹¶ä¸”é€šè¿‡éšæœºå…¨å±€å˜é‡åæ¥åŒºåˆ†ä¸åŒèµ„æºæ¥æš‚å­˜
ç–‘é—®ğŸ¤”ï¸ï¼šscriptæ ‡ç­¾çš„onloadäº‹ä»¶ä¼šç­‰jså†…å®¹æ‰§è¡Œå®Œè§¦å‘ï¼Ÿè€Œä¸æ˜¯åŠ è½½åˆ°jsæ–‡ä»¶å°±è§¦å‘å—ï¼Ÿæ˜¯å› ä¸ºimportå‘ç”Ÿåœ¨ç¼–è¯‘æ—¶æ‰€ä»¥omloadäº‹ä»¶å·²ç»æ‹¿åˆ°å˜é‡äº†ï¼Ÿ
éœ€è¦æ³¨æ„çš„æ˜¯è¯¥ç¤ºä¾‹ï¼Œç›¸åŒèµ„æºè¿˜æ˜¯ä¼šå†åŠ è½½ä¸€æ¬¡ï¼Œè€Œes6çš„import()ä¸ä¼šã€‚

å¦å¤–ï¼ŒBabelä¸ºè¿™ç§è¯­æ³•æä¾›äº†[dynamic-import-webpackæ’ä»¶](https://github.com/airbnb/babel-plugin-dynamic-import-webpack)ï¼Œä½ å¯ä»¥å®‰è£…å®ƒï¼Œå¹¶ç”¨å®ƒè§£æimport()åŒ¹é…ç¬¦ã€‚
æœ¬è´¨ä¸Šå®Œå…¨ä»¥webpackçš„`require.ensure()`æ¥å®ç°æŒ‰éœ€åŠ è½½ï¼Œè¿™æ ·ææ²¡æœ‰æ„ä¹‰ï¼Œ`import()`è¯­æ³•å‡ºç°çš„ç›®çš„å°±æ˜¯æ›¿ä»£`webpackçš„require.ensure()`ï¼Œç»“æœå› ä¸ºå…¼å®¹é—®é¢˜ï¼Œåˆç”¨babelè½¬å›webpackçš„æ–¹å¼
> webpackä¸­ï¼Œæ—©æœŸæœ‰ä¸€ä¸ª`require.ensure()`çš„è¯­æ³•è·Ÿ`import()`ä¸€æ ·ï¼Œæ˜¯æŠŠç›®æ ‡æ–‡ä»¶å•ç‹¬æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ä¼šæ‰“åˆ°ä¸»åŒ…ä¸­
> `import()`å‡ºæ¥ä¹‹åï¼Œ`requie.ensure()` æ˜¯ `webpack` ç‰¹æœ‰çš„ï¼Œå·²è¢« `import()` å–ä»£ã€‚-- [webpackå®˜æ–¹æ–‡æ¡£](https://webpack.docschina.org/api/module-methods/)

---

æ€è€ƒğŸ¤”ï¼šæ‰€ä»¥ç°ä»£å·¥ç¨‹ä¸‹çš„`import()`ï¼Œè¿˜æ˜¯ä¼šè¢«babelè½¬ç§»æˆ`require.ensure()`ï¼Ÿå¦‚æœä¸è½¬çš„è¯ï¼Œä¸æ”¯æŒçš„æµè§ˆå™¨æ€ä¹ˆè¯´ï¼Ÿ
å¦‚ä½•è§£å†³import()çš„å…¼å®¹é—®é¢˜ï¼Œå¦‚ä½•æŠŠéœ€è¦æŒ‰éœ€åŠ è½½çš„æ–‡ä»¶å‰¥ç¦»(æ‰“åŒ…)å‡ºæ¥ï¼Ÿ

ç°ä»£å·¥ç¨‹ä¸éœ€è¦ç”¨babelæ’ä»¶å¤„ç†`import()`,webpackåœ¨ç¼–è¯‘æ—¶è¿›è¡Œä¾èµ–æ”¶é›†ä¼šå¤„ç†æŒ‰éœ€åŠ è½½èµ„æºï¼Œç¼–è¯‘æˆwebpackè‡ªå·±çš„`__webpack_require__e`
æ‰€ä»¥å—é™äºå…¼å®¹é—®é¢˜ï¼Œå¾ˆå¤šå¥½ç”¨çš„å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨è¿è¡Œçš„es6è¯­æ³•ï¼Œä¼šè¢«webpackç¼–è¯‘æˆè‡ªå·±çš„å®ç°ï¼Œåˆ°æœ€åçœ‹åˆ°çš„æ•ˆæœå®é™…ä¸Šä¸æ˜¯es6çš„æˆæœ
TODO: `__webpack_require__e`åŸç†


çœ‹çœ‹[æ·±å…¥æµ…å‡ºwebpack](https://webpack.wuhaolin.cn/)è¿™æœ¬ä¹¦


ç»„ä»¶åº“æ­å»ºé˜¶æ®µï¼Œç»„ä»¶åº“æ›´æ–°æ€ä¹ˆè®©å¼•ç”¨æ–¹æ›´æ–°ç»„ä»¶

## æ³¨æ„ vue çš„ $attrs å±æ€§é€ä¼ ï¼Œä¸­å¿ƒç»„ä»¶ä¸èƒ½ç”¨propsæ¥æ”¶æ‰èƒ½é€ä¼ è¿›å» $attrs æœ¬è´¨å°±æ˜¯ç»„ä»¶ä¸æ¥æ”¶æ—¶æŒ‚åœ¨htmlæ ‡ç­¾ä¸Šçš„å±æ€§