# æ‰‹å†™å¾®å‰ç«¯demo

æ…•è¯¾ç½‘æ•™ç¨‹çš„ä¸»/å­åº”ç”¨ éƒ½æ˜¯åŸºäºwebpackçš„(vueé¡¹ç›®åŸºäºvue-cli)

åªæ˜¯ä¸ºäº†æ‰‹å†™æ¡†æ¶, ç¤ºä¾‹å°½å¯èƒ½ç®€å•

è¿™é‡Œåªåšä¸€ä¸ªç®€å•çš„ TabåŠŸèƒ½

æ¡†æ¶å®Œå–„å, ç¼–å†™ä¸€ä¸ªå†…ç®¡ç³»ç»Ÿ

[micro-frontend-learndemo - mygithub](https://github.com/luojinan/micro-frontend-learndemo)

ä»¥ `vite + åŸç”Ÿhtml/js` ä¸ºå®¿ä¸»åº”ç”¨æ­å»ºå¾®å‰ç«¯æ¡†æ¶

ä»¥ [webpack5 + vue2.7](https://github.com/luojinan/webpack5-vue2.7-template) ä¸ºå­åº”ç”¨

ä»¿ç…§ `qiankun` çš„ç®€æ˜“å¾®å‰ç«¯æ¡†æ¶

`qiankun` åˆæ˜¯åŸºäº `single-spa`
æ‰€ä»¥æœ¬demoå’Œ`qiankun`ã€`single-spa`ä¼šå¾ˆåƒ

ç›®å‰ä¸æ”¯æŒå­åº”ç”¨ä½¿ç”¨ `vite` æ‰“åŒ…å·¥å…·ï¼Œå› ä¸ºæ˜¯è¯»å–å­åº”ç”¨ `html` ç›´æ¥æ³¨å…¥ä¸»åº”ç”¨å®¹å™¨çš„

è€Œviteå¼€å‘é˜¶æ®µdevç”¨çš„æ˜¯esmï¼Œå¹¶ä¸”devæ‹¦æˆªèµ„æºæŒ‰éœ€ç¼–è¯‘ï¼Œä¸»åº”ç”¨ä¸­æœ¬åœ°ä¸ä¼šå¯åŠ¨å­åº”ç”¨ï¼Ÿ

TODO: å¾®å‰ç«¯åŸç† å¦å¼€ä¸€ç¯‡è®²

TODO: `microCore` å®ç°ç°åœ¨å¸‚é¢ä¸Šå¤šç§å¾®å‰ç«¯æ–¹æ¡ˆ, é€šè¿‡ä¸åŒçš„å…¥å£æ–‡ä»¶æš´éœ²å‡ºæ¥ä½¿ç”¨

- qiankun/single-spa é˜¿é‡Œ
- micor-app äº¬ä¸œé›¶å”®
- æ— ç•Œ
- iframe - æºç¨‹

## æ³¨å†Œå­åº”ç”¨é…ç½®ä¿¡æ¯

[qiankun-åœ¨ä¸»åº”ç”¨ä¸­æ³¨å†Œå¾®åº”ç”¨](https://qiankun.umijs.org/zh/guide/getting-started#2-%E5%9C%A8%E4%B8%BB%E5%BA%94%E7%94%A8%E4%B8%AD%E6%B3%A8%E5%86%8C%E5%BE%AE%E5%BA%94%E7%94%A8)

```js
import { registerMicroApps, start } from 'qiankun';

registerMicroApps([
  {
    name: 'react app', // app name registered
    entry: '//localhost:7100',
    container: '#yourContainer',
    activeRule: '/yourActiveRule',
  },
  {
    name: 'vue app',
    entry: { scripts: ['//localhost:7100/main.js'] },
    container: '#yourContainer2',
    activeRule: '/yourActiveRule2',
  },
]);

start();
```

æˆ‘ä»¬å®ç°è‡ªå·±çš„ `registerMicroApps`

æš‚æ—¶å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ä¸ªå­˜å‚¨åˆ° æ ¸å¿ƒç±»åº“ ä¸­çš„ä¸€äº›é…ç½®é¡¹

å¦‚ `vite.config.ts` ä¸­çš„ `defineConfig({})`

### åˆ›å»ºä¸»åº”ç”¨
ä½¿ç”¨ vite åˆ›å»ºåŸç”Ÿ html åº”ç”¨

ğŸ‘‡ `mainApp/src/main.ts`

```ts
import { registerMicroApps } from '../../microCore/index';
import './style.css'

document.querySelector<HTMLDivElement>('#app')!.innerHTML = `
  <div>
    <img src="/vite.svg" class="logo" alt="Vite logo" />
    <h1>Vite + TypeScript</h1>
  </div>
`

registerMicroApps([
  {
    name: 'vue3 app',
    entry: '//localhost:7100',
    container: '#yourContainer2',
    activeRule: '/vue2demo',
  }
]);
```
ğŸ‘† åˆ é™¤ä¸€äº›å¤šä½™å†…å®¹, å¹¶æŒ‰ `qiankun` è°ƒç”¨æ³¨å†Œå­åº”ç”¨æ–¹æ³• `registerMicroApps`

### åˆ›å»ºå¾®åº”ç”¨æ ¸å¿ƒåº“

å› ä¸ºæ˜¯ä¸»åº”ç”¨è°ƒç”¨æ ¸å¿ƒåº“, å› æ­¤ä¸»åº”ç”¨çš„ `ts` é…ç½®éœ€è¦åŒ…å« `æ ¸å¿ƒåº“` ç›®å½•

é…ç½® `mainApp/tsconfig.json` æ·»åŠ  `"../microCore"`
```json
"include": ["src", "../microCore"]
```

ğŸ‘‡ `microCore/index.ts`
```ts
// å¾®å‰ç«¯æ ¸å¿ƒç±»åº“ æä¾›ç»™ mainAPP ä½¿ç”¨
interface SubappInfo {
  name: string,
  entry: string,
  container: string,
  activeRule: string,
}

export function registerMicroApps(option :SubappInfo[]) {
  console.log('å­˜å‚¨å­åº”ç”¨æ³¨å†Œä¿¡æ¯', option)
}
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230118163805.png)

`microCore` æ–°å¢ `const/index.ts` ç”¨äºå­˜å‚¨è¿è¡Œæ—¶çš„æ³¨å†Œå­åº”ç”¨ä¿¡æ¯

```ts
import type { SubappInfo } from '../type'

let subappList:SubappInfo[] = []
export const getAppList = () => subappList
export const setList = (appList:SubappInfo[]) => subappList = appList
```

ğŸ‘‡ `microCore/index.ts`
```ts
// å¾®å‰ç«¯æ ¸å¿ƒç±»åº“ æä¾›ç»™ mainAPP ä½¿ç”¨
import { setAppList } from './const'
import type { SubappInfo } from './type'

export function registerMicroApps(option :SubappInfo[]) {
  setAppList(option) // <-- this
}
```

## æ‹¦æˆªè·¯ç”±
å®Œæˆæ³¨å†Œå­åº”ç”¨ä¿¡æ¯å, è°ƒç”¨ `å¾®å‰ç«¯æ ¸å¿ƒåº“` çš„ `start` æ¥é‡å†™è·¯ç”±æœºåˆ¶, è®©å­åº”ç”¨çš„è·¯ç”±éƒ½ç»è¿‡ `æ ¸å¿ƒåº“`

ğŸ‘‡ `microCore/router/rewriteRouter.ts`
```ts
/**
 * é‡å†™ history API
 */
export const rewriteRouter = () => {

  const originalPushState = window.history.pushState
  const originalReplaceState = window.history.replaceState

  window.history.pushState = function () {
    originalPushState.apply(this, arguments)
    console.log('history.pushState')
  }

  window.history.replaceState = function() {
    originalReplaceState.apply(this, arguments)
    console.log('history.replaceState')
  }

  window.onpopstate = function() {
    console.log('onpopstate')
  }
}
```

ğŸ‘‡ `microCore/index.ts`
```ts
export function registerMicroApps(option :SubappInfo[]) {
  setAppList(option)
  rewriteRouter() // <-- this
}
```

æ§åˆ¶å°è¾“å…¥ `history.pushState(null, '', '/foo')` è§¦å‘äº†æˆ‘ä»¬çš„æ‹¦æˆª `console`
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230118170503.png)

æµè§ˆå™¨å‰è¿›è¿”å›è§¦å‘ æ‰“å° `'onpopstate'`

ğŸ¤” è§†é¢‘é‡Œåˆ©ç”¨ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨æ¥è§¦å‘ å›è°ƒ

```ts
export const rewriteRouter = () => {
  rewriteOriginFn(window.history.pushState, 'customerEventListenerPush') // ä¼ å…¥ æœªæ‰§è¡Œçš„åŸç”Ÿæ–¹æ³• å’Œ è‡ªå®šä¹‰äº‹ä»¶åå­—ç¬¦ä¸²
  rewriteOriginFn(window.history.replaceState, 'customerEventListenerReplace')

  window.addEventListener('customerEventListenerPush', openApp) // åˆ›å»º è‡ªå®šä¹‰äº‹ä»¶
  window.addEventListener('customerEventListenerReplace', openApp)
}
```

```ts
function rewriteOriginFn(originFn, eventListenerName) {
  return function() {
    originFn.apply(this, argument) // æ‰§è¡ŒåŸç”Ÿæ–¹æ³•
    const e = new Event(eventListenerName) // åˆ©ç”¨ new Event æŠŠäº‹ä»¶ç›‘å¬å™¨åå­—ç¬¦ä¸² å®ä¾‹åŒ–ä¸º äº‹ä»¶
    window.dispatchEvent(e) // é€šè¿‡ dispatchEvent æ‰§è¡Œäº‹ä»¶å®ä¾‹
  }
}
```

ğŸ‘† `rewriteOriginFn` å°è£…é‡å†™åŸç”Ÿæ–¹æ³•çš„é‡å¤éƒ¨åˆ†å¯ä»¥ç†è§£

ğŸ¤” ä½†æ˜¯ç¬¬2ä¸ªå‚æ•°å®Œå…¨å¯ä»¥æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°, ä¸ºä»€ä¹ˆè¦ç”¨è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨çš„æ–¹å¼è°ƒç”¨å›è°ƒï¼ŸTODO: 

## å½“å‰URLåŒ¹é…å­åº”ç”¨æ³¨å†Œä¿¡æ¯

é€šè¿‡ `location` ä¸­çš„ `pathName` æ¥åŒ¹é…æ³¨å†Œä¿¡æ¯ä¸­çš„å­åº”ç”¨æ•°æ®å¯¹è±¡

åœ¨ `VueRouter` åŸç†æ–‡ç« ä¸­ æˆ‘ä»¬åˆ©ç”¨ `Vue.util.reactive` æŠŠå½“å‰Urlæ•°æ®è½¬ä¸ºå“åº”å¼æ•°æ®

é€šè¿‡ `watch` æ¥è§¦å‘ å›è°ƒ `render`

ç°åœ¨æ²¡æœ‰å“åº”å¼æ•°æ®, åˆ™éœ€è¦è‡ªå·±æ‰‹åŠ¨åœ¨æ‰€æœ‰ `URL` æ”¹å˜çš„åœ°æ–¹æ‰‹åŠ¨è§¦å‘ `render`
- é¡µé¢ `init` æ—¶, å¦‚æµè§ˆå™¨è¾“å…¥åœ°å€ `xxx/vue2demo/xx` æˆ– `åˆ·æ–°`
- ä¸»/å­åº”ç”¨, é€šè¿‡ `pushState` ç­‰æ–¹æ³•è·³è½¬é¡µé¢(å„ç°ä»£å‰ç«¯ `Router` çš„åŸç†åº•å±‚ )

åœ¨ `qiankun` è¿™äº›æ­¥éª¤å‘ç”Ÿåœ¨ `start()`

ğŸ‘‡ `microCore/utils/index.ts`
```ts
import { getAppList } from "../const"
import { SubappInfo } from "../type"

/**
 * è·å– URL ä¸Šçš„ pathname ä½œä¸º å­åº”ç”¨name
 * @returns 
 */
export const getSubappNameByUrl = () => {
  return window.location.pathname
}

/**
 * æ ¹æ®å½“å‰ URL å’Œ å­åº”ç”¨æ³¨å†Œåˆ—è¡¨ åŒ¹é…å‡ºå½“å‰å­åº”ç”¨ä¿¡æ¯
 */
export const getCurrentSubappInfo:()=>SubappInfo|null = () => {

  const appList = getAppList()
  const urlAppName = getSubappNameByUrl()

  const res = appList.find(item => item.activeRule === urlAppName)
  return res ?? null
}
```

ğŸ‘‡ `microCore/index.ts`
```ts
export function start() {
  // åˆ¤æ–­å­åº”ç”¨æ³¨å†Œæ˜¯å¦ä¸ºç©º
  const appList = getAppList()
  if(!appList.length) {
    throw 'å­åº”ç”¨åˆ—è¡¨ä¸ºç©º, è¯·ä½¿ç”¨ registerMicroApps() æ³¨å†Œè‡³å°‘1ä¸ªå­åº”ç”¨'
  }

  // è·å–å½“å‰ URL åŒ¹é…åˆ°çš„å­åº”ç”¨ä¿¡æ¯
  const currentAppInfo = getCurrentSubappInfo()
  if(!currentAppInfo) return

  console.log('currentAppInfo',currentAppInfo)
}
```

## ç¼–å†™ä¸»åº”ç”¨ Tab åŠŸèƒ½

```ts
document.querySelector<HTMLDivElement>('#app')!.innerHTML = `
  <div>
    <img src="/vite.svg" class="logo" alt="Vite logo" />
    <h1>Vite + TypeScript</h1>
    <ul>
      <li>/vue2demo#page1</li>
      <li>/vue2demo#page2</li>
    </ul>
  </div>
`
document.querySelectorAll('li')?.forEach(ele=>{
  ele.addEventListener('click',()=>{
    window.history.pushState(null,'', ele.innerText)
  })
})
```

## åŠ è½½å­åº”ç”¨

å‰é¢åªæ˜¯æ‹¦æˆªäº†è·¯ç”±æ²¡æœ‰å†™åŠ è½½é€»è¾‘

ğŸ‘‡ `microCore/load/loadSubApp.ts`
```ts
import { getCurrentSubappInfo } from "../utils"

export const loadApp = ()=>{
  // è·å–å½“å‰ URL åŒ¹é…åˆ°çš„å­åº”ç”¨ä¿¡æ¯
  const currentAppInfo = getCurrentSubappInfo()
  if(!currentAppInfo) return

  console.log('åŠ è½½', currentAppInfo.activeRule)
}
```
ğŸ‘† å¯ä»¥çœ‹å‡ºå’Œ `start` é‡Œé€»è¾‘é‡å¤, `start` å¤„ç†åˆå§‹åŒ–å’Œåˆ·æ–°é€»è¾‘

åœ¨è·¯ç”±ç›‘å¬é€»è¾‘é‡Œéƒ½è°ƒç”¨è¿™ä¸ªå‡½æ•°

â• æœŸæœ›çš„æ•ˆæœæ˜¯ å­åº”ç”¨åˆ‡æ¢æ—¶æ‰åŠ è½½ åŒä¸€ä¸ªå­åº”ç”¨ä¸åº”è¯¥å†æ¬¡åŠ è½½

æ‰€ä»¥åº”è¯¥åˆ¤æ–­ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ ä¸ åˆ‡æ¢çš„å­åº”ç”¨æ˜¯å¦åŒä¸€ä¸ªï¼ŒåŒä¸€ä¸ªæ—¶ä¸è§¦å‘ `load`

æš‚æ—¶ç”¨å…¨å±€å˜é‡å­˜ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨

ğŸ‘‡ `microCore/load/loadSubApp.ts`
```ts
/**
 * åŠ è½½ å­åº”ç”¨
 * @returns 
 */
export const loadApp = ()=>{
  // è·å–å½“å‰ URL åŒ¹é…åˆ°çš„å­åº”ç”¨ä¿¡æ¯
  const currentAppInfo = getCurrentSubappInfo()
  if(!currentAppInfo) return

  if(window.__CURRENT_SUB_APP__ === currentAppInfo.activeRule) return

  console.log('åŠ è½½', currentAppInfo.activeRule)

  window.__CURRENT_SUB_APP__ = currentAppInfo.activeRule // å®šä¹‰ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ åˆ¤æ–­åŒä¸€ä¸ªå­åº”ç”¨ä¸è§¦å‘load
}
```

tså®šä¹‰ `Window` å…¨å±€å˜é‡ åªè¦åœ¨ `tsconfig.json` è¯†åˆ«èŒƒå›´å†…ï¼Œå®šä¹‰åœ¨å“ªéƒ½å¯ä»¥

ğŸ‘‡ `microCore/type.ts`
```ts
declare global {
  interface Window {
    __CURRENT_SUB_APP__: string;
  }
}
```

æ­¤æ—¶è¿˜æ²¡æœ‰ç¼–å†™åˆæ¬¡åŠ è½½é¡µé¢/åˆ·æ–°æ—¶åŠ è½½çš„é€»è¾‘

ä¸€èˆ¬æ¥è¯´å’Œç›‘å¬è·¯ç”±é‡Œçš„é€»è¾‘é‡å¤å†™

ä½†æ˜¯å°è¯•ä¸€ä¸‹ åŠ è½½é¡µé¢/åˆ·æ–° æ—¶è§¦å‘ `pushState` ä»è€Œè§¦å‘è·¯ç”±ç›‘å¬è¯•è¯• ä¼šä¸ä¼šå› æ­¤å¤šå‡ºä¸€å±‚è·¯ç”±

`/vue2demo push /vue2demo`

æµè§ˆå™¨è¿”å›æ—¶ æ˜¯å¦ä¼šå¯¼è‡´2å±‚

ç›´æ¥åœ¨æ§åˆ¶å°æµ‹è¯•ä¸‹æ¥ `pushstate` ä¸å½“å‰ `location.href` ä¸ä¼šå¤šå‡ºä¸€å±‚ç›¸åŒçš„å†å²

ä½†æ˜¯åœ¨å®é™…ç¼–å†™çš„æ—¶å€™ï¼Œåœ¨æœ‰è·¯ç”±å†å²çš„æƒ…å†µä¸‹ `åˆ·æ–°å¹¶è§¦å‘pushstateå½“å‰url` ä¼šä¸¢å¤±å†å²ï¼Œç›¸å½“äºåˆ·æ–°åçš„è·¯ç”±å˜æˆäº†é¦–ä¸ªè·¯ç”±

TODO: ä¸ `pushstate` çš„åˆ·æ–°å¯ä»¥æ­£å¸¸è¿”å›ï¼Œ ä¸åˆ·æ–°çš„ `pushstate` ä¹Ÿå¯ä»¥è¿”å›, ä½†æ˜¯åˆ·æ–° + `pushstate` å°±è¿™æ ·äº†ï¼Ÿï¼Ÿï¼Ÿ

è¿™é‡Œæš‚æ—¶å…ˆ é‡å¤å†™ç›‘å¬è·¯ç”±é‡Œç›¸åŒçš„é€»è¾‘

ğŸ‘‡ `microCore/index.ts`
```ts
export function start() {
  // åˆ¤æ–­å­åº”ç”¨æ³¨å†Œæ˜¯å¦ä¸ºç©º
  const appList = getAppList()
  if(!appList.length) {
    throw 'å­åº”ç”¨åˆ—è¡¨ä¸ºç©º, è¯·ä½¿ç”¨ registerMicroApps() æ³¨å†Œè‡³å°‘1ä¸ªå­åº”ç”¨'
  }

  // è·å–å½“å‰ URL åŒ¹é…åˆ°çš„å­åº”ç”¨ä¿¡æ¯
  // const currentAppInfo = getCurrentSubappInfo()
  // if(!currentAppInfo) return

  // console.log('init currentAppInfo',location.pathname + location.hash)
  // history.pushState(null, '', location.href)
  // window.__CURRENT_SUB_APP__ = currentAppInfo.activeRule // å®šä¹‰ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ åˆ¤æ–­åŒä¸€ä¸ªå­åº”ç”¨ä¸è§¦å‘load
  loadApp() // <-- this
}
```

## ä¸»åº”ç”¨ä¸­å®šä¹‰é€šç”¨ç”Ÿå‘½å‘¨æœŸ

åœ¨ä¸»åº”ç”¨ç¼–å†™ ç”Ÿå‘½å‘¨æœŸ

`microCore` çš„æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨ä¼ å…¥è¿›æ¥çš„ç”Ÿå‘½å‘¨æœŸ

ä¹Ÿå°±æ˜¯ä¼šä½œç”¨äºåŠ è½½æ‰€æœ‰å­åº”ç”¨çš„è¿‡ç¨‹x

ğŸ‘‡ ä¸»åº”ç”¨å…¥å£æ–‡ä»¶æ³¨å†Œå­åº”ç”¨ä¿¡æ¯
```ts
registerMicroApps(subAppList,
  {
    beforeLoad:[
      ()=>{
        console.log('å¼€å§‹åŠ è½½')
      }
    ],
    mounted:[
      ()=>{
        console.log('æ¸²æŸ“å®Œæˆ')
      }
    ],
    destoryed:[
      ()=>{
        console.log('é”€æ¯å®Œæˆ')
      }
    ]
  }
)
```
ç”Ÿå‘½å‘¨æœŸçš„é’©å­é€»è¾‘æ˜¯ç®€å•çš„å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼ŒæŠŠæœªæ‰§è¡Œçš„å‡½æ•°åˆ—è¡¨å…ˆå­˜å‚¨èµ·æ¥ï¼Œåœ¨æ‰§è¡Œåˆ°çš„æŸä¸ªæ—¶æœºå»ç›¸åº”çš„è°ƒç”¨è¿™äº›å‡½æ•°

æˆ‘ä»¬å’Œå­˜å‚¨å­åº”ç”¨ä¿¡æ¯æ–¹å¼ç›¸åŒ åˆ›å»º `microCore/const/mainLifeCycle.ts`

```ts
import type { LifeCycles } from '../type'

let mainLifeCycles:LifeCycles = {}
export const getMainlLifeCycles = () => mainLifeCycles
export const setMainlLifeCycles = (mainlLifeCycles:LifeCycles) => mainLifeCycles = mainlLifeCycles
```

ğŸ‘‡ `microCore/type.ts`
```ts
export interface LifeCycles {
  beforeLoad?: Function[],
  mounted?: Function[],
  destoryed?: Function[],
}
```

ç¼–å†™è°ƒç”¨é€»è¾‘

å› ä¸ºä¸Šé¢ é¦–æ¬¡åŠ è½½/åˆ·æ–° å’Œ ç›‘å¬è·¯ç”±å˜åŒ–è§¦å‘ çš„ `loadSubApp` æŠ½ç¦»åˆ°äº†ä¸€èµ·

å› æ­¤ `microCore/load/loadSubApp.ts`

```ts
export const loadApp = async ()=>{
  // è·å–å½“å‰ URL åŒ¹é…åˆ°çš„å­åº”ç”¨ä¿¡æ¯
  const currentAppInfo = getCurrentSubappInfo()
  if(!currentAppInfo) return

  if(window.__CURRENT_SUB_APP__ === currentAppInfo.activeRule) return

  console.log('åŠ è½½', currentAppInfo.activeRule)

  // 1. è°ƒ å¼€å§‹å‰ ç”Ÿå‘½å‘¨æœŸ // <-- this
  const {beforeLoad, mounted, destoryed} = getMainlLifeCycles()
  beforeLoad?.forEach(fn=>fn())

  // 2. åŠ è½½å­åº”ç”¨(è€—æ—¶) // <-- this
  await sleep()
  mounted?.forEach(fn=>fn())

  // 3. è°ƒ å®Œæˆ ç”Ÿå‘½å‘¨æœŸ // <-- this
  destoryed?.forEach(fn=>fn())

  window.__CURRENT_SUB_APP__ = currentAppInfo.activeRule // å®šä¹‰ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ åˆ¤æ–­åŒä¸€ä¸ªå­åº”ç”¨ä¸è§¦å‘load
}
```

ç”Ÿå‘½å‘¨æœŸæ•ˆæœå¦‚ ğŸ‘‡
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/microlife.gif)

### ç”Ÿå‘½å‘¨æœŸloadingå®è·µ

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230121152432.png)

è¡¨ç¤ºå·¦è¾¹çš„è¡¨è¾¾å¼ä¸èƒ½åˆ¤æ–­æ˜¯å¦æœ‰å€¼å†èµ‹å€¼, å³ä½¿æœ‰ `?.` ä¹Ÿä¸èƒ½ç¡®å®š innerHTML æ˜¯å¦å­˜åœ¨

æ¢æˆ `!.` å°±èƒ½æ’é™¤æ‰å‰é¢æ˜¯ `null` å’Œ `undefined`çš„æƒ…å†µ `document.querySelector('#yourContainer')!.innerHTML = 'å­åº”ç”¨åŠ è½½ä¸­'`

TODO:


## å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸ºæ³¨å†Œä¿¡æ¯å¯¹è±¡ä¸­çš„å±æ€§

```ts
registerMicroApps([
  {
    name: 'vue2.7 app',
    entry: '//localhost:7100',
    container: '#yourContainer',
    activeRule: '/vue2demo',
    beforeLoad: () => console.log('vue2demo ç”Ÿå‘½å‘¨æœŸ beforeLoad'), // <-- å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
    mounted: () => console.log('vue2demo ç”Ÿå‘½å‘¨æœŸ mounted'),
    destoryed: () => console.log('vue2demo ç”Ÿå‘½å‘¨æœŸ destoryed')
  }
], {
  beforeLoad: [], // <-- ä¸»åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
  mounted: [],
  destoryed: [],
})
```
ğŸ‘† ä¸»/å­åº”ç”¨ ç”Ÿå‘½å‘¨æœŸè§¦å‘æ—¶æœºç›¸åŒ ç›¸å½“äºä¸»åº”ç”¨è®¾ç½®é€šç”¨é€»è¾‘ å­åº”ç”¨è®¾ç½®è‡ªå®šä¹‰é€»è¾‘

è¦è·å–å‰å­åº”ç”¨å’Œåå­åº”ç”¨, æ‰èƒ½åˆ†åˆ«è§¦å‘ä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸ

åœ¨åŒ¹é…åˆ°ç›®æ ‡è·¯å¾„æ˜¯æ³¨å†Œä¿¡æ¯ä¸­çš„å¦ä¸€ä¸ªå­åº”ç”¨æ—¶
ğŸ‘‡ ä¿®æ”¹å½“å‰å­åº”ç”¨å…¨å±€å˜é‡æ ‡è¯† çš„åŒæ—¶è®°å½•åŸå­åº”ç”¨è·¯å¾„
```ts
window.__ORIGIN_SUB_APP__ = window.__CURRENT_SUB_APP__ // ä¿®æ”¹ __CURRENT_SUB_APP__ çš„å€¼å‰ è®°å½•åŸå€¼ä½œä¸º preSubApp
window.__CURRENT_SUB_APP__ = currentAppInfo.activeRule // å®šä¹‰ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ åˆ¤æ–­åŒä¸€ä¸ªå­åº”ç”¨ä¸è§¦å‘load
```

ğŸ‘‡ è°ƒç”¨ç›®å½•å­åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸éœ€è¦åˆ¤æ–­
```ts
export const loadApp = async ()=>{
  // è·å–å½“å‰ URL åŒ¹é…åˆ°çš„å­åº”ç”¨ä¿¡æ¯
  const currentAppInfo = getCurrentSubappInfo()
  if(!currentAppInfo) return

  if(window.__CURRENT_SUB_APP__ === currentAppInfo.activeRule) return

  // 1. è°ƒ å¼€å§‹å‰ ç”Ÿå‘½å‘¨æœŸ
  const {beforeLoad, mounted, destoryed} = getMainlLifeCycles()
  beforeLoad?.forEach(fn=>fn())
  currentAppInfo?.beforeLoad?.() // <-- this

  // 2. åŠ è½½å­åº”ç”¨(è€—æ—¶) è°ƒ å®Œæˆ ç”Ÿå‘½å‘¨æœŸ
  await sleep()
  mounted?.forEach(fn=>fn())
  currentAppInfo?.mounted?.() // <-- this

  window.__ORIGIN_SUB_APP__ = window.__CURRENT_SUB_APP__ // ä¿®æ”¹ __CURRENT_SUB_APP__ çš„å€¼å‰ è®°å½•åŸå€¼ä½œä¸º preSubApp
  window.__CURRENT_SUB_APP__ = currentAppInfo.activeRule // å®šä¹‰ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ åˆ¤æ–­åŒä¸€ä¸ªå­åº”ç”¨ä¸è§¦å‘load
}
```

ğŸ‘‡ è°ƒç”¨é”€æ¯ åˆ™éœ€è¦è·å–ä¸Šä¸€ä¸ªå­åº”ç”¨å­˜åœ¨æ—¶, å¹¶ä¸”æ—¶æœºæ˜¯ä¿®æ”¹å…¨å±€å˜é‡å˜é‡ä¹‹å

```ts
export const loadApp = async ()=>{

  // ... ç•¥
  window.__ORIGIN_SUB_APP__ = window.__CURRENT_SUB_APP__ // ä¿®æ”¹ __CURRENT_SUB_APP__ çš„å€¼å‰ è®°å½•åŸå€¼ä½œä¸º preSubApp
  window.__CURRENT_SUB_APP__ = currentAppInfo.activeRule // å®šä¹‰ å½“å‰å·²åŠ è½½çš„å­åº”ç”¨ åˆ¤æ–­åŒä¸€ä¸ªå­åº”ç”¨ä¸è§¦å‘load

  // 3. é”€æ¯ä¸Šä¸€ä¸ªå­åº”ç”¨è°ƒ é”€æ¯ ç”Ÿå‘½å‘¨æœŸ // <-- this
  const preSubApp = findSubAppInfo(window.__ORIGIN_SUB_APP__)
  if(preSubApp) {
    destoryed?.forEach(fn=>fn())
    preSubApp?.destoryed?.()
  }
}
```

## nodejsè„šæœ¬æ‰¹é‡å¯åŠ¨å‰ç«¯é¡¹ç›®

åˆå§‹åŒ–[vue2.7 + webpack å­åº”ç”¨](https://github.com/luojinan/webpack5-vue2.7-template)

ğŸ‘‡ `run.mjs`
```js
import { spawn } from 'node:child_process'
import { fileURLToPath, URL } from 'node:url'

const demoPath = {
  vue2: fileURLToPath(new URL('./subApp', import.meta.url)),
  main: fileURLToPath(new URL('./mainApp', import.meta.url))
}

Object.values(demoPath).forEach(path => {
  spawn(`cd ${path} && pnpm dev`, { stdio: 'overlapped', shell: true })
})
```

## åŠ è½½å¹¶æ¸²æŸ“å­åº”ç”¨èµ„æº

ğŸ‘‡ `microCore/loadResource.ts`
```ts
/**
 * fetch è¯·æ±‚é™æ€èµ„æºè¿”å›æ–‡ä»¶å†…å®¹
 * @param url 
 * @returns 
 */
export const fetchResource = (url:string) => {
  return fetch(url).then(res => res.text())
}
```

ğŸ‘‡ è·¨åŸŸé—®é¢˜ 

`subApp/build/webpack.dev.config.js`
```js
devServer: {
  allowedHosts: 'all', // æ— æ•ˆ...
  headers: { 'Access-Control-Allow-Origin': '*' }, // allowedHosts é…ç½®äº†ä¹Ÿä¸èƒ½è·¨åŸŸè®¿é—®æœ¬é™æ€èµ„æºæœåŠ¡å™¨ éœ€è¦é…ç½® headers
}
```
ğŸ‘† å­åº”ç”¨ `devServer` é…ç½®å…è®¸è·¨åŸŸ

### è§£æHTMLå†…å®¹

ğŸ‘‡ æŠŠè¯»å–åˆ°çš„ `html` æ–‡æœ¬å†…å®¹é€šè¿‡ `innerHTML` æŒ‚è½½åˆ°å­åº”ç”¨é…ç½®ä¿¡æ¯çš„ `container` èŠ‚ç‚¹ä¸Š

```ts
const htmlContent = await fetchResource(currentAppInfo.entry) // è¯·æ±‚åˆ° html å†…å®¹
mountSubApp(htmlRes, currentAppInfo)
```

```ts
const mountSubApp = (htmlContent:string, appInfo:SubappInfo) => {
  const subAppRootDom = document.querySelector(appInfo.container)
  subAppRootDom!.innerHTML = htmlContent
}
```

è‡³æ­¤, `html` è™½ç„¶æŒ‚è½½ä¸Šå»äº†, ä½†æ˜¯å­åº”ç”¨å†…å®¹æ˜¯ç©ºçš„, å› ä¸ºå­åº”ç”¨æ˜¯ `SPA` åº”ç”¨, éœ€è¦åŠ è½½åˆ°å­åº”ç”¨ `JS` æ‰èƒ½æ¸²æŸ“å‡ºå†…å®¹

### è§£æJSå†…å®¹

```ts
/**
 * è§£æ HTMl æ–‡æœ¬å†…å®¹ æˆ JS/CSS/HTML æ•°æ®
 */
export const pasrseHtml = (htmlContent:string) => {

  // 1. åˆ›å»ºä¸€ä¸ªdivå­˜æ”¾ fetch åˆ°çš„htmlæ–‡æœ¬å†…å®¹
  // è¿™ä¹ˆåšæ˜¯ä¸ºäº†å»æ‰html body æ ‡ç­¾,  æ–¹ä¾¿æ•°æ®å¤„ç†å’Œé€’å½’
  const divDom = document.createElement('div')
  divDom.innerHTML = htmlContent
  parseScript(divDom) // æ­¤æ—¶çš„ divDom çš„å†…å®¹æ˜¯å¹³çº§çš„ meta div script
  
  return htmlContent
}
```

é€’å½’ç»“æ„

```ts
const parseScript = (root: HTMLDivElement) => {

  function deepParse (element) {
    const children = element.children // ç±»æ•°ç»„ ä¸èƒ½ç”¨forEach
    for (const item of children) {
      deepParse(item)
    }
  }

  deepParse(root)
}
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230122102505.png)

ğŸ‘‡ å¤„ç†js
```ts
function deepParse (element:HTMLElement) {

  if(element.nodeName.toLowerCase() === 'script') {
    const src = element.getAttribute('src')
    if(!src) {
      // éå¤–éƒ¨é“¾æ¥çš„jsèµ„æº å†…è”é€»è¾‘
      script.push(element.outerHTML)
    } else {
      // å¤–éƒ¨é“¾æ¥ ç»å¯¹è·¯å¾„/ç›¸å¯¹è·¯å¾„
      if(src.startsWith('http')) {
        scriptUrl.push(src)
      }else{
        scriptUrl.push(`http:${entry}/${src}`)
      }
    }
  }

  const children = element.children // ç±»æ•°ç»„ ä¸èƒ½ç”¨forEach
  for (const item of children) {
    deepParse(item)
  }
}
```

å¾—åˆ° `script` è¯·æ±‚çš„ ç»å¯¹è·¯å¾„, é€šè¿‡ `fetch` è¯·æ±‚å¾—åˆ° jsæ–‡æœ¬å†…å®¹

ğŸ‘‡ é€šè¿‡ `eval` æ‰§è¡Œ jsæ–‡æœ¬å†…å®¹
```ts
const [htmlRes, jsList] = await pasrseHtml(htmlContent, currentAppInfo.entry)
mountSubApp(htmlRes, currentAppInfo)
jsList.forEach(item => eval(item))
```

è‡³æ­¤ å­åº”ç”¨çš„ å†…å®¹ä¹Ÿæ¸²æŸ“å‡ºæ¥äº†

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230122111055.png)

## è°ƒæ•´å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸåŠæ¨¡å—åŒ–

ğŸ‘† é…ç½®å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸæ˜¯åœ¨ æ³¨å†Œå­åº”ç”¨ä¿¡æ¯ æ—¶ç¼–å†™çš„

ä¸ºäº†å…è®¸ å­åº”ç”¨ å‰ç«¯åº”ç”¨å¯ä»¥ç‹¬ç«‹è¿è¡Œ(ä¸ä¾é ä¸»åº”ç”¨)

éœ€è¦ å­åº”ç”¨ çš„å…¥å£é€»è¾‘åˆ†ä¸º2ç§æƒ…å†µè§¦å‘
1. å¸¸è§„ SPA åŠ è½½ å…¥å£é€»è¾‘ ç«‹å³è§¦å‘æ¸²æŸ“
2. å¾®å‰ç«¯ç¯å¢ƒ ç”±ä¸»åº”ç”¨è°ƒç”¨å­åº”ç”¨ä¸­çš„ç”Ÿå‘½å‘¨æœŸ(ä¸Šé¢å®šä¹‰åœ¨å­åº”ç”¨æ³¨å†Œä¿¡æ¯ä¸­)è§¦å‘æ¸²æŸ“

è®¾ç½® å¾®å‰ç«¯ç¯å¢ƒå˜é‡ å‘Šè¯‰ å‰ç«¯é¡¹ç›® ç°åœ¨æ˜¯ä½œä¸ºå­åº”ç”¨è¿è¡Œåœ¨å¾®å‰ç«¯çš„ä¸»åº”ç”¨é‡Œ

### ä¿®æ”¹å­åº”ç”¨å…¥å£é€»è¾‘

```js
import Vue from 'vue'
import App from './App.vue'

Vue.config.productionTip = false

const render = () => {
  new Vue({
    render: h => h(App)
  }).$mount('#app')
}

// å…¥å£é€»è¾‘ç«‹å³æ‰§è¡Œ new Vue æ”¹ä¸ºéå¾®å‰ç«¯ç¯å¢ƒä¸‹ æ‰§è¡Œ
if (!window.__MICRO_WEB__) {
  render()
}

// æŠ›å‡º å­åº”ç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°
export const beforeLoad = () => console.log('vue2demo ç”Ÿå‘½å‘¨æœŸ beforeLoad')
export const mounted = () => {
  console.log('vue2demo ç”Ÿå‘½å‘¨æœŸ mounted')
  render() // å¾®å‰ç«¯ç¯å¢ƒä¸‹ ç”±ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œ new Vue
}
export const destoryed = () => console.log('vue2demo ç”Ÿå‘½å‘¨æœŸ destoryed')
```

ğŸ‘‡ æ‰§è¡Œå­åº”ç”¨å…¥å£é€»è¾‘å‰ è®¾ç½®ç¯å¢ƒå˜é‡
```ts
window.__MICRO_WEB__ = true // æ‰§è¡Œå­åº”ç”¨å…¥å£é€»è¾‘å‰ è®¾ç½®ç¯å¢ƒå˜é‡
jsList.forEach(item=>eval(item))
```

### ä¿®æ”¹å­åº”ç”¨æ‰“åŒ…æ¨¡å—åŒ–æ–¹å¼

ğŸ‘‡ å­åº”ç”¨ å‡ºå£é…ç½® `webpack`
```js
output: {
  path: resolveApp('dist'),
  filename: 'js/[name].[hash:6].js',
  chunkFilename: 'js/[name].chunk.[hash:4].js',

  // æŠŠå­åº”ç”¨æ‰“åŒ…æˆ umd åº“æ ¼å¼ // <-- this
  library: 'vue2demo',
  libraryTarget: 'umd'
}
```

ğŸ‘‡ `devServer` æ‰“åŒ…åçš„ `chunk`
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230122162404.png)

### æ‰§è¡Œjsæ–‡æœ¬è·å–æŠ›å‡ºçš„å˜é‡

è¦è·å–åˆ° umd æ¨¡å—åŒ–æŠ›å‡ºçš„å†…å®¹, åªè¦æ»¡è¶³ä¸€ç§åˆ¤æ–­æ¡ä»¶å°±è¡Œ

- CJS
- AMD
- å…¨å±€å˜é‡

è§†é¢‘çš„åšæ³•æ˜¯é€šè¿‡å…¨å±€å˜é‡è·å–åˆ°é‡Œé¢æŠ›å‡ºçš„å†…å®¹
```ts
window.__MICRO_WEB__ = true // æ‰§è¡Œå­åº”ç”¨å…¥å£é€»è¾‘å‰ è®¾ç½®ç¯å¢ƒå˜é‡
jsList.forEach(item => eval(item))

console.log(window.vue2demo) // <-- this { beforeLoad, ... }
```
ğŸ‘† TODO: å¥‡æ€ªçš„æ˜¯åªèƒ½æ‰§è¡Œä¸€æ¬¡, å¦‚ vue2 -> vue3 -> vue2 ç¬¬äºŒæ¬¡ vue2 åŠ è½½å¹¶æ‰§è¡Œ umd å, window.vue2demo ä¸º undefined, æ— æ³•æ‰§è¡Œ mounted

å¯ä»¥ç”¨ tsup æ‰“åŒ…ä¸€ä¸ªç®€å•æ¨¡å—åŒ– umd åŒ…å°è¯•è®¿é—®å¤šæ¬¡

é™¤æ­¤ä¹‹å¤–ï¼Œ æˆ‘ä»¬è¿˜å¯ä»¥ä¼ªé€ ä¸€ä¸ªç¬¦åˆ CJS åˆ¤æ–­æ¡ä»¶çš„å¯¹è±¡ç”¨äºè·å–

æ‰‹å†™è¿‡ CJS å°±çŸ¥é“è¯¥æ¨¡å—åŒ–çš„æœ¬è´¨å°±æ˜¯å¾€ä¸€ä¸ªå¯¹è±¡ä¸­å­˜å‚¨æ•°æ®, å†è·å–å‡ºæ¥

```ts
window.__MICRO_WEB__ = true // æ‰§è¡Œå­åº”ç”¨å…¥å£é€»è¾‘å‰ è®¾ç½®ç¯å¢ƒå˜é‡

window.exports = {} // <-- this
jsList.forEach(item => eval(item))

console.log(window.exports) // <-- this { vue2demo: { beforeLoad, ...} }
```

## æ²™ç®±æœºåˆ¶

### å¿«ç…§æ²™ç®±
åœ¨å­åº”ç”¨jsé€»è¾‘ä¸­æŒ‚è½½æŒ‚è½½å˜é‡åˆ° `window` ä¸Š, å¸Œæœ›è¿™ä¸ªæ“ä½œè¢«éš”ç¦»

å› ä¸ºå­åº”ç”¨æ‰€æœ‰çš„ js é€»è¾‘éƒ½åœ¨ `UMD` æ¨¡å—åŒ–ä¸­

åªè¦æƒ³åŠæ³•æŠŠè¿™ä¸ª `UMD` æ¨¡å—å†…éƒ¨çš„ `window` è¢«æ”¹å†™å°±å¯ä»¥äº†

å¯ä»¥é€šè¿‡å±€éƒ¨å˜é‡å®ç° æ¨¡å—å†…è®¿é—® `window` å°±ä¼˜å…ˆå–å±€éƒ¨å˜é‡

é¦–å…ˆ æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¢«æ”¹å†™çš„ `window` (ä¹Ÿå°±æ˜¯ä¸€ä»½æ‹·è´)
è¿™ç§æ–¹å¼ç§°ä¸º `å¿«ç…§æ²™ç®±`
```ts
export const snapShotSandbox = () => {
  const sandboxWindow = {}

  const getSandboxWindow = ()=>{
    return sandboxWindow
  }

  const active = () => {
    for (const key in window) {
      sandboxWindow[key] = window[key]
    }
    return getSandboxWindow()
  }

  const inactive = () => {
    for (const key in window) {
      const sandboxVal = sandboxWindow[key]
      if(window[key] !== sandboxVal) {
        try {
          window[key] = sandboxVal
        } catch (error) {
          console.log('è¿˜åŸå¿«ç…§window err', error)
        }
      }
    }
  }
  return {
    active, inactive
  }
}
```

ğŸ‘‡ æ³¨å…¥åˆ° umd ä¸­
```ts
const jsText = `
  (()=>{
    const self = ${sandboxWindow}
    ${item}
  })()
`
eval(jsText)
```
ğŸ‘† æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•ä¸­æ‹¼æ¥çš„å˜é‡ å¯¹è±¡æ—¶è¢«è½¬å­—ç¬¦ä¸²ä¼šæ˜¯ `[object Object]`

å› æ­¤ä¸èƒ½è¿™ä¹ˆæŠŠ æ‹·è´çš„ window å¡è¿›å»

åªèƒ½æŒ‚è½½åœ¨ window ä¸‹, é€šè¿‡å­—ç¬¦ä¸²è®¿é—®åˆ°
```ts
const { active } = snapShotSandbox()
window.sandboxWindow = active()

const jsText = `
  (()=>{
    const self = window.sandboxWindow
    ${item}
  })()
`
eval(jsText)
```
ğŸ‘† æŠ¥é”™ self is not a function

çŒœæµ‹ä¸èƒ½ç”¨ self å˜é‡, ä¼šè‡ªåŠ¨è¢«æµè§ˆå™¨è½¬ä¸º window


```ts
const jsText = `
  (()=>{
    const window = window.sandboxWindow
    ${item}
  })()
`
```
ğŸ‘† æŠ¥é”™ window å†…ç½®å˜é‡ä¸èƒ½ä½œå˜é‡å

```ts
const jsText = `
  ((window)=>{
    ${item}
  })(window.sandboxWindow)
`
eval(jsText)
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230122185558.png)

ğŸ‘† å¯ä»¥å‘ç°è¿™æ ·ä¹Ÿæ˜¯ä¸å¯¹çš„ è¦é€šè¿‡ `window.sandboxWindow` æ‰èƒ½è®¿é—®

æˆ‘ä»¬å†æ¥ğŸ¤”ä¸€ä¸‹

åœ¨å­åº”ç”¨jsé€»è¾‘ä¸­æŒ‚è½½æŒ‚è½½å˜é‡åˆ° `window` ä¸Š, å¸Œæœ›è¿™ä¸ªæ“ä½œè¢«éš”ç¦»

åªè¦æƒ³åŠæ³•æŠŠ `UMD` æ¨¡å—å†…éƒ¨çš„ `window` è¢«æ”¹å†™å°±å¯ä»¥äº†

å¯ä»¥é€šè¿‡å±€éƒ¨å˜é‡å®ç° æ¨¡å—å†…è®¿é—® `window` å°±ä¼˜å…ˆå–å±€éƒ¨å˜é‡

ğŸ‘† è¿™ç§æ€è·¯çš„æ•ˆæœå°±å­åº”ç”¨æ“ä½œçš„æ˜¯è‡ªå·±çš„ä½œç”¨åŸŸ, è¿™æ ·å°±ä¸ä¸åƒæ˜¯ä¸€ä¸ªåº”ç”¨äº†

è¦çš„æ•ˆæœæ˜¯ åˆ‡æ¢åˆ° å­åº”ç”¨A , å¿«ç…§æ‹·è´ä¸€ä»½è¢«å­åº”ç”¨æ“ä½œå‰çš„ `window`

å½“åˆ‡æ¢åˆ°å…¶ä»–å­åº”ç”¨å‰æŠŠ `window` è¿˜åŸä¸ºå¿«ç…§ `window` (ä¹Ÿå°±æ˜¯å­åº”ç”¨æ“ä½œçš„æ˜¯çœŸæ­£çš„ `window` åªä¸è¿‡è¿™æ¬¡æ“ä½œä¼šåœ¨ä¹‹åè¿˜åŸ)


ğŸ‘‡ umd æ‰§è¡Œä¾ç„¶ç›´æ¥æ“ä½œ window
```ts
jsList.forEach(item => eval(item)) // è§¦å‘ç¬¬äºŒæ¬¡ eval å…¨å±€æ¨¡å—å˜é‡ä¼šè¢«ç½®ç©º?
```

ğŸ‘‡ é€šè¿‡é”€æ¯å­åº”ç”¨æ—¶æœº è¿˜åŸå›åŸæ¥çš„ window
```ts
const { active, inactive } = snapShotSandbox()
currentAppInfo.sandbox = { active, inactive } // å­˜å‚¨åˆ°å­åº”ç”¨ä¿¡æ¯ä¸­ ç”¨äºé€šè¿‡ä¸Šä¸€ä¸ªå­åº”ç”¨æ¥è¿˜åŸå¯¹åº”çš„(æ¯ä¸ªå­åº”ç”¨çš„æ²™ç®±å¿«ç…§ä¸åŒ)æ²™ç®±å¿«ç…§
active()

// 3. é”€æ¯ä¸Šä¸€ä¸ªå­åº”ç”¨è°ƒ é”€æ¯ ç”Ÿå‘½å‘¨æœŸ
const preSubApp = findSubAppInfo(window.__ORIGIN_SUB_APP__)
if(preSubApp) {
  // è¿˜åŸ window ä¸ºå¿«ç…§
  preSubApp?.sandbox?.inactive()
}
```

### ä»£ç†æ²™ç®±

å¿«ç…§æ²™ç®±ä¸æ”¯æŒåŒæ—¶å¯åŠ¨å¤šä¸ªå­åº”ç”¨

é€šè¿‡ `new Proxy` è®©æ‰€æœ‰å­åº”ç”¨æ“ä½œçš„ `window` æ˜¯å¦ä¸€ä¸ªå¯¹è±¡(æ¨¡å—åŒ–ä¸­ä¼ å…¥çš„ `window` ä¸èƒ½æ˜¯åŸ `window` è€Œæ˜¯ä»£ç†åçš„ `window`)

`set` çš„éƒ½æ˜¯å¦ä¸€ä¸ªå¯¹è±¡

`get` æ—¶åˆ™åˆ¤æ–­å¦ä¸€ä¸ªå¯¹è±¡å±æ€§æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å–åŸ window ä¸Šçš„å±æ€§

```ts
export const proxySandbox = () => {
  let proxyWindow = {} // æ¯ä¸ªå­åº”ç”¨éƒ½è°ƒç”¨ä¸€æ¬¡ active å³ proxyWindow ä¸ä¼šå¤ç”¨

  const active = () => {
    return new Proxy(window, {
      get(window, key){
        return proxyWindow[key] || window[key]
      },
      set(window, key, newVal){
        proxyWindow[key] = newVal
        return true
      }
    })
  }

  const inactive = () => {
    proxyWindow = {}
  }

  return {
    active, inactive
  }
}
```

```ts
// const { active, inactive } = snapShotSandbox() // <-- this
const {active, inactive} = proxySandbox()
currentAppInfo.sandbox = { active, inactive } // å­˜å‚¨åˆ°å­åº”ç”¨ä¿¡æ¯ä¸­ ç”¨äºé€šè¿‡ä¸Šä¸€ä¸ªå­åº”ç”¨æ¥è¿˜åŸå¯¹åº”çš„(æ¯ä¸ªå­åº”ç”¨çš„æ²™ç®±å¿«ç…§ä¸åŒ)æ²™ç®±å¿«ç…§
const proxyWindow = active()


// jsList.forEach(item => eval(item)) // è§¦å‘ç¬¬äºŒæ¬¡ eval å…¨å±€æ¨¡å—å˜é‡ä¼šè¢«ç½®ç©º?
window.proxyWindow = proxyWindow
jsList.forEach(item => {
  eval(`
    ((window)=>{
      ${item}
    })(window.proxyWindow)
  `)
})
```
ğŸ‘† [å¿«ç…§æ²™ç®±](#å¿«ç…§æ²™ç®±) ä¸­æåˆ°ä¸èƒ½ç”¨ window ä½œå˜é‡åæ¥æ”¹å†™, å› æ­¤ç”¨ window çš„ä¸´æ—¶å˜é‡ä¼ å…¥(å½“å¤šä¸ªå­åº”ç”¨æ—¶ ä¸´æ—¶å˜é‡å°†æ ¹æ®æ‰§è¡Œé¡ºåºéœ€è¦è¢«å¤šæ¬¡æ”¹å†™, å› æ­¤å¤šä¸ªå­åº”ç”¨æ—¶å±äºä¸å¯ä¿¡çš„å˜é‡, ä¸å»ºè®®æ“ä½œæˆ–è¯»å–å®ƒ)

éªŒè¯: ä¸»/å­åº”ç”¨ åˆ†åˆ«åŠ ä¸€ä¸ªæŒ‰é’® `console` å‡º `window.a` (ç”¨æ§åˆ¶å°ä¸èƒ½æ“ä½œåˆ°ä»£ç†å `window`, åªä¼šè¾“å‡ºåŸ `window`)

```ts
// ä¸»åº”ç”¨
document.querySelector('button')?.addEventListener('click', ()=>{
  console.log(window.a) // --> undefined
})

// vue2.7 å­åº”ç”¨
setup(){
  function getWindowA () {
    console.log(window.a) // --> '1'
  }
  return {
    getWindowA
  }
}
```
## æ ·å¼éš”ç¦»

### CSS Modules

### shadow DOM

### å­åº”ç”¨å•ç‹¬cssæ–‡ä»¶

webpack ä¸€èˆ¬æ‰“åŒ…ç”Ÿäº§ç¯å¢ƒçš„ css ä¼šæ‹†åˆ†å‡ºæ¥

è€Œåªè¦æ‹†åˆ†å‡ºæ¥ æ ¹æ®å­åº”ç”¨åˆ‡æ¢è¯·æ±‚ä»¥åŠç§»é™¤ç›¸å…³ CSS æ–‡ä»¶ å°±è‡ªç„¶å½¢æˆäº†æ ·å¼éš”ç¦»

## é€šä¿¡ 46 47 48 49

- é€šè¿‡ç”Ÿå‘½å‘¨æœŸ å¾€ å­åº”ç”¨info é‡Œæ”¾ä¸€ä¸ªå…±äº«æ•°æ®/æ–¹æ³• è‡ªå®šä¹‰æ•°æ®ç»“æ„æ¥æ“ä½œå¯¹æ–¹
- customevent - åŸç”Ÿè‡ªå¸¦çš„å‘å¸ƒè®¢é˜…åŠŸèƒ½ ç­‰åŒäº è‡ªå·±å†™ä¸ªå‘å¸ƒè®¢é˜…ç±» eventBus.on/emit

## storeå­˜å‚¨

ä¸»åº”ç”¨ å…¥å£æ–‡ä»¶å¾€ `window` ä¸ŠæŒ‚è½½å¾®å‰ç«¯æ ¸å¿ƒæä¾›çš„ `store`

å­åº”ç”¨é€šè¿‡ `window.store` æ“ä½œ (æ²¡æœ‰vueçš„å“åº”å¼åŠŸèƒ½, åªæ˜¯æ™®é€šçš„æ•°æ®å­˜å‚¨å…±äº«)

ğŸ‘‡ å­˜å‚¨æ•°æ® å¹¶ æä¾› å‘å¸ƒè®¢é˜… update åè‡ªåŠ¨è§¦å‘
```ts
import { Store } from "../type"
/**
 * æ“ä½œå­˜å‚¨æ•°æ®çš„åŠŸèƒ½ store
 * å¹¶ æä¾› å‘å¸ƒè®¢é˜… update åè‡ªåŠ¨è§¦å‘
 */
export const createStore:()=>Store = () => {
  let store = {}
  const observers: Function[] = []

  const getStore = () => store

  const setStore = (newVal:{}) => {
    // newVal ä¸ç­‰äº åŸæ•°æ® æ‰è§¦å‘å‘å¸ƒè®¢é˜…
    if(newVal !== store) {
      const oldVal = store // æš‚å­˜å èµ‹æ–°å€¼
      store = newVal
      // è‡ªåŠ¨è§¦å‘å‘å¸ƒè®¢é˜…
      observers.forEach(fn => fn(newVal, oldVal))
    }
  }

  const addSubscribe = (fn: Function) => {
    observers.push(fn)
  }

  return {
    getStore, setStore, addSubscribe
  }
}
```


ğŸ‘‡ ä¸»åº”ç”¨ 
```ts
window.store = createStore()
// æ·»åŠ è®¢é˜…è€… æ¯æ¬¡ä¿®æ”¹ store éƒ½ä¼šè§¦å‘è¿™ä¸ªå›è°ƒ
window.store.addSubscribe((newVal:{}, oldVal:{}) => {
  console.log('Subscribe', newVal,oldVal)
})

const originStore = window.store.getStore()
window.store.setStore({
  ...originStore,
  a: 'a'
})

registerMicroApps()
start()
```

å­åº”ç”¨å°±å¯ä»¥é€šè¿‡ `window.store` æ“ä½œ

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜å­åº”ç”¨é™æ€èµ„æº

é¦–æ¬¡ `fetch` å­åº”ç”¨ `html/JS` æ—¶ç¼“å­˜
åç»­åˆ‡æ¢æ—¶ä¸å‘å‡º `fetch` è¯·æ±‚

```ts
const cache = {} // ä»¥å­åº”ç”¨name æ¥ç¼“å­˜html/JS å†…å®¹

// 2. åŠ è½½å­åº”ç”¨(è€—æ—¶) è°ƒ å®Œæˆ ç”Ÿå‘½å‘¨æœŸ
// æ·»åŠ ç¼“å­˜åˆ¤æ–­
if(!cache[currentAppInfo.name]) {
  const htmlContent = await fetchResource(currentAppInfo.entry)
  const [htmlRes, jsList] = await pasrseHtml(htmlContent, currentAppInfo.entry)
  cache[currentAppInfo.name] = [htmlRes, jsList] // æ·»åŠ ç¼“å­˜
}

const [htmlRes, jsList] = cache[currentAppInfo.name]
mountSubApp(htmlRes, currentAppInfo)
```

### é¢„åŠ è½½å­åº”ç”¨

åŠ è½½å½“å‰å­åº”ç”¨ç»“æŸå å°±åŠ è½½å…¶ä»–å­åº”ç”¨

ğŸ‘‡ ä¸»åº”ç”¨
```ts
registerMicroApps()

start()

preFetchApp(['/vue2demo'])
```

```ts
import { findSubAppInfo, getUrlPathName } from "../utils"
import { fetchApp } from "./cacheFetch"

export const preFetchApp = (appNameList:string[]) => {
  appNameList.forEach(appname => {
    const urlAppName = getUrlPathName()
    if(urlAppName === appname) return  // å½“å‰pathnameåŠ è½½ç”± start è§¦å‘ return é¿å…é‡å¤åŠ è½½

    const appinfo = findSubAppInfo(appname)
    if(appinfo) {
      fetchApp(appinfo)
    }
  })
}
```

```ts
import { SubappInfo } from "../type"
import { fetchResource, pasrseHtml } from "./loadResource"

const cache = {} // ä»¥å­åº”ç”¨name æ¥ç¼“å­˜html/JS å†…å®¹

export const fetchApp = async (appinfo:SubappInfo) => {
  // æ·»åŠ ç¼“å­˜åˆ¤æ–­
  if(!cache[appinfo.name]) {
    const htmlContent = await fetchResource(appinfo.entry)
    const [htmlRes, jsList] = await pasrseHtml(htmlContent, appinfo.entry)
    cache[appinfo.name] = [htmlRes, jsList] // æ·»åŠ ç¼“å­˜
  }

  return cache[appinfo.name]
}
```

ts æ€ä¹ˆå®šä¹‰ è¿è¡Œæ—¶çš„ å¯¹è±¡æ•°æ®
å¦‚ğŸ‘† `cahce[name]` å…¶ä¸­name æ˜¯ç”¨æˆ·è¾“å…¥çš„å€¼ ç”¨ typeof ï¼Ÿ

## npmå‘å¸ƒå¹¶åŠ è‡ªåŠ¨åŒ–æµç¨‹ 55 - 61
