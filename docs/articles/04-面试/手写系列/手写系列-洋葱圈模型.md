
![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221215164550.png)

## Koaä¸­é—´ä»¶ç°è±¡

ç”¨ `Koa` ä¸­é—´ä»¶`(Middleware)`ä»ç°è±¡å‡ºå‘ï¼Œç†è§£æ´‹è‘±æ¨¡å‹

æŒ‰ç…§ `Koa` ä¸­é—´ä»¶è§„èŒƒï¼Œç¼–å†™ä¸¤ä¸ªä¸­é—´ä»¶

ğŸ‘‡ åˆ›å»º `Koa` å®ä¾‹å¹¶æŒ‚è½½ `logTimeã€logUrl` ä¸­é—´ä»¶
```js
const Koa = require('koa')
const app = new Koa()

const logTime = require('./middleware/logTime')
const logUrl = require('./middleware/logUrl')

app.use(logTime())
app.use(logUrl())

// response
app.use(async ctx => {
  ctx.body = 'Hello World'
})

app.listen(3000)
```

ğŸ‘‡ è°ƒç”¨è¿™ä¸ªä¸­é—´ä»¶ ä¼šæ‰“å°å‰/å
```js
module.exports = function() {
  return async function(ctx, next) {
    console.log(
      "nextå‰ï¼Œæ‰“å°æ—¶é—´æˆ³:",
      new Date().getTime()
    )

    await next()

    console.log(
      "nextåï¼Œæ‰“å°æ—¶é—´æˆ³:",
      new Date().getTime()
    )
  }
}
```

ğŸ‘‡ è°ƒç”¨è¿™ä¸ªä¸­é—´ä»¶ ä¼šæ‰“å°ä¸Šä¸‹æ–‡çš„url
```js
module.exports = function() {
  return async function(ctx, next) {
    console.log("nextå‰ï¼Œæ‰“å°url:", ctx.url)

    await next()

    console.log("nextåï¼Œæ‰“å°url:", ctx.url)
  }
}
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20221215111721.png)

ğŸ‘† ä»¥ä¸­é—´ä»¶ä»£ç ä¸Šçš„`nextå‡½æ•°` ä¸ºåˆ†ç•Œç‚¹ï¼šå…ˆ `use` çš„ä¸­é—´ä»¶ï¼Œ `next` å‰çš„é€»è¾‘å…ˆæ‰§è¡Œï¼Œä½† `next` åçš„é€»è¾‘åè€Œåæ‰§è¡Œ

---

ğŸ¤” è¿™æ ·ç›¸å¯¹äºé“¾å¼æ‰§è¡Œä¸­é—´ä»¶æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

æˆ‘ä»¬æå‡ºè¿™æ ·çš„éœ€æ±‚
å¸Œæœ›ä¸­é—´ä»¶ä¿®æ”¹åçš„çŠ¶æ€èƒ½ä¸å…³å¿ƒæŒ‚è½½é¡ºåºï¼Œåœ¨ä»»æ„ä¸­é—´ä»¶ä¸­è¯»å–åˆ°ï¼ˆä¸æ„å‘³ç€ä¸­é—´ä»¶æŒ‚è½½é¡ºåºéšæ„å†™ï¼Œé¡ºåºå†³å®šä¸­é—´ä»¶å›è°ƒæ‰§è¡Œæ—¶æœºï¼‰

å¦‚ï¼šåœ¨ç¬¬äºŒä¸ªä¸­é—´ä»¶ logUrl é‡Œï¼Œå¯¹urlåŠ ä¸Šäº†ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œç„¶ååœ¨ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ logTime é‡Œæ‹¿åˆ°è¿™ä¸ªæ—¶é—´æˆ³urlå¹¶æ‰“å°

å¦‚æœæ™®é€šçš„é“¾å¼æ‰§è¡Œæ‰€æœ‰ä¸­é—´ä»¶(ä¸€ä¸ªå›è°ƒå‡½æ•°)ï¼Œæ˜¾ç„¶æ— æ³•å®ç°å‰é¢çš„ä¸­é—´ä»¶èƒ½ä½¿ç”¨ä¹‹åçš„ä¸­é—´ä»¶æ‰€æ·»åŠ çš„ä¸œè¥¿
å°±éœ€è¦åœ¨ä¸€ä¸ªä¸­é—´ä»¶é‡ŒåŒæ—¶å®šä¹‰ 1.é¡ºåºæ‰§è¡Œçš„å›è°ƒå‡½æ•° 2.å…¨éƒ¨ä¸­é—´ä»¶æ‰§è¡Œåçš„å›è°ƒå‡½æ•° ï¼Œè¿™æ ·æ¥å…±äº«ä¸€äº›å•ä¸ªä½œç”¨åŸŸçš„å˜é‡

---

ğŸ¤” nextå‡½æ•°æ˜¯æ´‹è‘±åœˆæ¨¡å‹éœ€è¦æ‰ç”¨çš„å—ï¼Ÿè¿˜æ˜¯ç”¨äºå…¶ä»–ä½œç”¨ï¼Ÿ
å®šä¹‰ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å†…éƒ¨æä¾›preå‡½æ•°å’Œpostå‡½æ•°


ğŸ¤” ä¸­é—´ä»¶preçš„å›è°ƒå…¨éƒ¨æ‰§è¡Œå®Œï¼Œæ‰§è¡Œpostå›è°ƒçš„é¡ºåºä¸ºä»€ä¹ˆåè¿‡æ¥

ä¿ç•™nextåˆ†å‰²ä¸­é—´ä»¶å‰åçš„åŠŸèƒ½ï¼Œå¦‚ä¸­é—´1ã€2å†…éƒ¨å„è‡ªæœ‰nextå‰/åï¼Œæ‰§è¡Œé¡ºåºä¸º
- ä¸­é—´ä»¶1çš„nextå‰
- ä¸­é—´ä»¶2çš„nextå‰
- ä¸­é—´ä»¶1çš„nextå
- ä¸­é—´ä»¶2çš„nextå



---

## æ‰‹å†™Koaæ´‹è‘±åœˆ

### åˆ›å»ºä¸­é—´ä»¶
```js
const middleWare1 = (next) => {
  console.log('first start')
  next()
  console.log('first end')
}
const middleWare2 = (next) => {
  console.log('second start')
  next()
  console.log('second end')
}
const middleWare3 = () => {
  console.log('third no next')
}
```

### åˆ›å»ºkoaå®ä¾‹ï¼Œæä¾›useæŒ‚è½½ä¸­é—´ä»¶ï¼Œrunæ‰§è¡Œä¸­é—´ä»¶
```js
export createKoa() {
  let middlewares = []

  // æŒ‚è½½ä¸­é—´ä»¶
  const use = (middleWare) => {
    middlewares.push(middleWare)
  }

  // æ‰§è¡Œä¸­é—´ä»¶
  const run = () => { }

  return {
    use,
    run
  }
}
```

### ç¤ºä¾‹ä½¿ç”¨ä»£ç 
```js
import { createKoa } from 'mykoa'

const koa = createKoa()

koa.use(middleWare1)
koa.use(middleWare2)
koa.use(middleWare3)

koa.run()
```

### ç¼–å†™æ‰§è¡Œä¸­é—´ä»¶çš„run

ğŸ‘‡ çœ‹èµ·æ¥ç›´æ¥éå†æ‰§è¡Œä¸­é—´ä»¶æ•°ç»„å°±å¥½
```js
const next = () => { }

// æ‰§è¡Œä¸­é—´ä»¶
const run = () => {
  middlewares.forEach( middleware => {
    middleware(next) // ç»™ä¸­é—´ä»¶æ³¨å…¥next
  })
}
```

âŒ ä¸èƒ½éå†æ‰§è¡Œï¼Œå› ä¸ºè¦ç”±nextå‡½æ•°æ¥æ§åˆ¶ä¸‹ä¸€ä¸ªæ‰§è¡Œ

```js
// æ‰§è¡Œä¸­é—´ä»¶
const run = () => {
  let middleware1 = middlewares[0]
  middleware1(function next(){
    // nextå†…éƒ¨æ¥æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´
    let middleware2 = middlewares[1]
    middleware2(function next(){
      ...
    })
  })
}
```
ğŸ‘† æ˜¯é€’å½’ç»“æ„

```js
// æ‰§è¡Œä¸­é—´ä»¶
const run = () => {
  dispatch(0)

  function dispatch (i) {
    if (i === middlewares.length) return null // è·³å‡ºé€’å½’

    const middleware = middlewares[i]

    // ä¸­é—´ä»¶æ³¨å…¥next(æ¯æ¬¡éƒ½ä¸ä¸€æ ·)
    const next = () => {
      dispatch(i + 1) // é€’å½’æ‰§è¡Œè‡ªèº«
    }
    middleware(next)
  }
}
```
ğŸ‘† å¯ä»¥å‘ç°æˆ‘ä»¬åªå¤„ç† `next` ä¸‹ä¸€ä¸ªä¸­é—´ä»¶(å³å‡½æ•°æ‰§è¡Œåˆ° `next` å‰çš„é€»è¾‘å†…å®¹)ï¼Œå¹¶æ²¡æœ‰åœ¨å¤„ç†å…¨éƒ¨ä¸­é—´ä»¶ä¹‹åï¼Œæ‰§è¡Œ `next` åçš„æ­¥éª¤

å…¶å®åœ¨ä¸€ä¸ªä¸­é—´ä»¶æ‰§è¡Œ `next` ä¹‹åï¼Œæ‰§è¡Œé¡ºåºè¢«ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªä¸­é—´
å½“è¿™ä¸ª `next` ä¸­æ–­
ä¹Ÿå°±å¼€å§‹æ‰§è¡Œæœ€åä¸€ä¸ªä¸­é—´ä»¶ `next` ä¸‹çš„ä»£ç å—äº†
ä»¥æ­¤å›åˆ°å‰ä¸€ä¸ªä¸­é—´ä»¶ `next` ä¸‹çš„ä»£ç å—

## å¯¹è±¡ç»“æ„ä¸­é—´ä»¶ï¼ŒåŒå¾ªç¯

ğŸ¤” é‚£ä¸ä½¿ç”¨ `nextå‡½æ•°é£æ ¼æ–¹å¼` çš„å¯¹è±¡ç»“æ„çš„ä¸­é—´ä»¶éå†æ‰§è¡Œå›è°ƒæ˜¯å¦å¯è¡Œ

ğŸ‘‡ å¯¹è±¡ç»“æ„çš„ä¸­é—´ä»¶
```js
const middleWare1 = {
  pre: () => console.log('first start'),
  post: () => console.log('first end')
}
const middleWare2 = {
  pre: () => console.log('second start'),
  post: () => console.log('second end')
}
const middleWare3 = () => console.log('third no next')
```

ğŸ‘‡ æ‰§è¡Œä¸­é—´ä»¶
```js
const run = (middlewares) => {
  middlewares.forEach(middleware => {
    if(typeof middleware === 'function'){
      middleware()
      return
    }
    middleware.pre()
  });

  // åè½¬ä¸­é—´ä»¶æ•°ç»„éå†
  middlewares.reverse().forEach(middleware => {
    if(typeof middleware === 'function') return
    middleware.post()
  });
}
```

ğŸ‘† å¾ªç¯2æ¬¡å’Œé€’å½’çš„æ—¶é—´å¤æ‚åº¦åº”è¯¥æ˜¯ç›¸åŒçš„ï¼Œå®ç°æ•ˆæœä¸Šä¹Ÿç›¸åŒ
å¦‚æœéœ€è¦ä¸­é—´ä»¶ä¹‹é—´å…±äº«çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä¾èµ–è¢«æŒ‚è½½çš„å®ä¾‹(Koaå®ä¾‹)å˜é‡å®ç°

ä¼¼ä¹é€’å½’å½¢å¼çš„å†™æ³•ä»…ä»…æ˜¯æ›´ä¼˜é›…ï¼Œè€Œä¸æ˜¯è¿™ç§ä½¿ç”¨åœºæ™¯çš„å”¯ä¸€è§£

## MidWay

[MidWay - A Node.js Serverless Framework for front-end/full-stack developers.](https://github.com/midwayjs/midway)

## umi-request

[umi-request - A request tool based on fetch](https://github.com/umijs/umi-request)

TODO: æºç ç¬”è®°

## Reduxä¸­é—´ä»¶

## å‚è€ƒææ–™

- [å¦‚ä½•æ›´å¥½åœ°ç†è§£ä¸­é—´ä»¶å’Œæ´‹è‘±æ¨¡å‹](https://juejin.cn/post/6890259747866411022)